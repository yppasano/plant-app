<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡æ˜“OCRãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        video, canvas, img { max-width: 100%; border: 1px solid #ccc; margin-bottom: 10px; }
        #output { 
            background: #f0f0f0; 
            padding: 10px; 
            white-space: pre-wrap; 
            text-align: left; 
            min-height: 100px;
            border-radius: 5px;
        }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 5px; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <h2>ğŸ“· ã‚«ãƒ¡ãƒ©OCRãƒ†ã‚¹ãƒˆ</h2>

    <video id="video" autoplay playsinline></video>
    
    <div>
        <button id="snap">æ’®å½±ã—ã¦è§£æ</button>
        <button id="retry" class="hidden">ã‚‚ã†ä¸€åº¦</button>
    </div>

    <canvas id="canvas" class="hidden"></canvas>
    
    <h3>è§£æçµæœ:</h3>
    <div id="status">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...</div>
    <div id="output"></div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snapBtn = document.getElementById('snap');
        const retryBtn = document.getElementById('retry');
        const statusDiv = document.getElementById('status');
        const outputDiv = document.getElementById('output');

        // 1. ã‚«ãƒ¡ãƒ©ã®èµ·å‹•
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }) // èƒŒé¢ã‚«ãƒ¡ãƒ©å„ªå…ˆ
            .then(stream => {
                video.srcObject = stream;
                statusDiv.textContent = "æº–å‚™å®Œäº†: å¯¾è±¡ã‚’æ˜ ã—ã¦ã€Œæ’®å½±ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„";
            })
            .catch(err => {
                console.error("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:", err);
                statusDiv.textContent = "ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
            });

        // 2. æ’®å½±ã¨OCRå®Ÿè¡Œ
        snapBtn.addEventListener('click', () => {
            // UIåˆ‡ã‚Šæ›¿ãˆ
            video.classList.add('hidden');
            canvas.classList.remove('hidden');
            snapBtn.classList.add('hidden');
            retryBtn.classList.remove('hidden');
            
            // æ˜ åƒã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æç”»ï¼ˆé™æ­¢ç”»åŒ–ï¼‰
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

// 1. ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
let data = imageData.data;

// 2. ãƒ”ã‚¯ã‚»ãƒ«ã”ã¨ã«å‡¦ç†ï¼ˆã‚°ãƒ¬ãƒ¼ã‚¹ã‚±ãƒ¼ãƒ«åŒ– ï¼† 2å€¤åŒ–ï¼‰
for (let i = 0; i < data.length; i += 4) {
    // æ˜ã‚‹ã•ã‚’è¨ˆç®— (RGBã®åŠ é‡å¹³å‡)
    const avg = (data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114);
    
    // ã—ãã„å€¤ï¼ˆä¾‹ãˆã°100ã€œ128ã‚ãŸã‚Šï¼‰ã‚ˆã‚Šæ˜ã‚‹ã‘ã‚Œã°ã€Œç™½ã€ã€æš—ã‘ã‚Œã°ã€Œé»’ã€ã«ã™ã‚‹
    const threshold = 100; 
    const color = avg > threshold ? 255 : 0;

    data[i] = color;     // Red
    data[i + 1] = color; // Green
    data[i + 2] = color; // Blue
    // Alpha(é€æ˜åº¦)ã¯ãã®ã¾ã¾
}

// 3. åŠ å·¥ã—ãŸç”»åƒã‚’ã‚­ãƒ£ãƒ³ãƒã‚¹ã«æˆ»ã™
context.putImageData(imageData, 0, 0);


            // OCRé–‹å§‹
            statusDiv.textContent = "â³ æ–‡å­—ã‚’è§£æä¸­... (åˆå›ã¯ãƒ‡ãƒ¼ã‚¿DLã«æ™‚é–“ãŒã‹ã‹ã‚Šã¾ã™)";
            outputDiv.textContent = "";

            // Tesseract.jsã«ã‚ˆã‚‹è§£æ
            // 'eng'ã¯è‹±èª, 'jpn'ã¯æ—¥æœ¬èªã€‚æ··ãœã‚‹å ´åˆã¯ 'eng+jpn'
            Tesseract.recognize(
                canvas, 
                'eng+jpn', 
                {
                    logger: m => {
                        // é€²æ—çŠ¶æ³ã‚’è¡¨ç¤º
                        if(m.status === 'recognizing text') {
                            statusDiv.textContent = `è§£æä¸­... ${Math.round(m.progress * 100)}%`;
                        }
                    }
                }
                ).then(async ({ data: { text } }) => {

                // ã€è¿½åŠ ã€‘ã“ã“ã§ã€AIã«é€ã‚‹æ–‡å­—ã‚’è‡ªåˆ†ã®ç›®ã§ç¢ºèªã™ã‚‹ï¼
                alert(`ã€ç¢ºèªã€‘AIã«é€ã‚‹æ–‡å­—:\n${text}`);

                statusDiv.textContent = "ğŸ¤– AIãŒè§£æä¸­...";
                console.log("ç”Ÿãƒ‡ãƒ¼ã‚¿:", text);

                // ã•ã£ãä½œã£ãŸAPIã«æŠ•ã’ã‚‹
                try {
                    const response = await fetch('/api/correct-text', {
                        method: 'POST',
                        body: JSON.stringify({ text: text }) // èª­ã¿å–ã£ãŸæ±šã„æ–‡å­—ã‚’é€ã‚‹
                    });

                    const result = await response.json();
                    
                    if (result.id && result.id !== "NOT_FOUND") {
                        // æˆåŠŸï¼
                        plantIdInput.value = result.id;
                        statusDiv.textContent = `âœ¨ è§£ææˆåŠŸ: ${result.id}`;
                        alert(`èª­ã¿å–ã‚ŠæˆåŠŸï¼\nID: ${result.id}`);
                    } else {
                        // å¤±æ•—ï¼ˆIDãŒè¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸï¼‰
                        statusDiv.textContent = "âš ï¸ IDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ";
                        alert("IDã‚‰ã—ãæ–‡å­—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nã‚‚ã†ä¸€åº¦æ’®å½±ã—ã¦ãã ã•ã„ã€‚");
                    }

                } catch (error) {
                    console.error(error);
                    statusDiv.textContent = "âŒ AIé€šä¿¡ã‚¨ãƒ©ãƒ¼";
                    alert("AIã®å‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
                }

            }).catch(err => {
                statusDiv.textContent = "âŒ ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
                console.error(err);
            });
        });

        // 3. ãƒªã‚»ãƒƒãƒˆï¼ˆã‚‚ã†ä¸€åº¦æ’®å½±ï¼‰
        retryBtn.addEventListener('click', () => {
            video.classList.remove('hidden');
            canvas.classList.add('hidden');
            snapBtn.classList.remove('hidden');
            retryBtn.classList.add('hidden');
            statusDiv.textContent = "æº–å‚™å®Œäº†";
            outputDiv.textContent = "";
        });
    </script>
</body>
</html>