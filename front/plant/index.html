<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ¤ç‰©ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .guide-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 200px;
      border: 3px dashed #14b8a6;
      border-radius: 12px;
      pointer-events: none;
      background: rgba(20, 184, 166, 0.1);
    }
    .guide-text {
      position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      background: #14b8a6;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
      white-space: nowrap;
    }
    .fab {
      position: fixed;
      right: 20px;
      bottom: 80px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
      z-index: 40;
      transition: transform 0.2s;
    }
    .fab:active {
      transform: scale(0.9);
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: black;
      z-index: 50;
      display: flex;
      flex-direction: column;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .action-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-radius: 20px 20px 0 0;
      z-index: 50;
      animation: slideUp 0.3s ease-out;
      box-shadow: 0 -4px 16px rgba(0,0,0,0.2);
    }
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    .highlight-card {
      animation: highlight 1.5s ease-in-out;
    }
    @keyframes highlight {
      0%, 100% { background-color: white; }
      50% { background-color: #a7f3d0; }
    }
    .accordion-header {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .accordion-header:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .accordion-content.expanded {
      max-height: 500px;
      transition: max-height 0.3s ease-in;
    }
    .arrow-icon {
      transition: transform 0.3s ease;
    }
    .arrow-icon.rotated {
      transform: rotate(180deg);
    }
/* === è¿½åŠ : è©³ç´°ãƒªã‚¹ãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³ === */
.stats-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.95rem;
      color: #4b5563;
    }
    .stats-row:last-child {
      border-bottom: none;
    }
    .stats-label {
      font-size: 0.85rem;
      color: #9ca3af;
    }
    .stats-value {
      font-weight: 600;
      color: #374151;
    }
    
    /* === è¿½åŠ : æ§ãˆã‚ãªå‰Šé™¤ãƒœã‚¿ãƒ³ === */
    .delete-link {
      display: inline-block;
      margin-top: 15px;
      font-size: 0.8rem;
      color: #9ca3af; /* è–„ã„ã‚°ãƒ¬ãƒ¼ */
      text-decoration: underline;
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
    }
    .delete-link:hover {
      color: #ef4444; /* ãƒ›ãƒãƒ¼æ™‚ã ã‘èµ¤ã */
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 pb-20">

  <!-- ========== ãƒ¡ã‚¤ãƒ³ç”»é¢ ========== -->
  <div id="mainScreen" class="max-w-md mx-auto">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-teal-600 text-white p-4 sticky top-0 z-30 shadow-md flex justify-between items-center">
      <h1 class="text-2xl font-bold">ğŸŒ¿ æ¤ç‰©ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†</h1>
      <button id="settingsBtn" class="text-2xl hover:opacity-80 transition">âš™ï¸</button>
    </header>

    <!-- æ¤œç´¢ãƒãƒ¼ -->
    <div class="p-4 bg-white border-b">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="ğŸ” IDã§æ¤œç´¢ (ä¾‹: A-01)" 
        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500"
      />
    </div>

    <!-- ã‚½ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="px-4 py-2 bg-white border-b flex justify-between items-center">
      <span class="text-sm text-gray-600 font-semibold">ä¸¦ã³æ›¿ãˆ:</span>
      <select id="sortSelect" class="bg-white border border-gray-300 text-gray-700 text-sm rounded-lg p-2">
        <option value="created">â–¼ ç™»éŒ²é † (æ–°ã—ã„é †)</option>
        <option value="id">A-Z IDé †</option>
        <option value="alert">ğŸ’§ æ°´ã‚„ã‚Šå¾…ã¡é †</option>
      </select>
    </div>

    <!-- æ¤ç‰©ãƒªã‚¹ãƒˆ -->
    <div id="plantList" class="p-4 space-y-3"></div>

    <!-- ãƒªã‚¹ãƒˆãŒç©ºã®å ´åˆ -->
    <div id="emptyState" class="hidden text-center py-12 text-gray-400">
      <p class="text-lg mb-2">ğŸ“ ç™»éŒ²ã•ã‚ŒãŸæ¤ç‰©ãŒã‚ã‚Šã¾ã›ã‚“</p>
      <p class="text-sm">å³ä¸‹ã® ï¼‹ ãƒœã‚¿ãƒ³ã§æ¤ç‰©ã‚’è¿½åŠ ã§ãã¾ã™</p>
    </div>
  </div>

  <!-- ========== Floating Action Button ========== -->
  <button id="fabBtn" class="fab bg-teal-600 hover:bg-teal-700 text-white">
    ï¼‹
  </button>

  <!-- ========== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒˆï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ ========== -->
  <div id="actionSheetOverlay" class="hidden fixed inset-0 bg-black/30 z-40" onclick="closeActionSheet()"></div>
  <div id="actionSheet" class="hidden action-sheet">
    <div class="p-6 space-y-3">
      <h3 class="text-lg font-bold text-gray-800 mb-4">è¿½åŠ æ–¹æ³•ã‚’é¸æŠ</h3>
      <button id="cameraOptionBtn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 rounded-lg text-lg flex items-center justify-center gap-2">
        ğŸ“· ã‚«ãƒ¡ãƒ©ã§è¿½åŠ 
      </button>
      <button id="manualOptionBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 rounded-lg text-lg flex items-center justify-center gap-2">
        âŒ¨ï¸ æ‰‹å‹•ã§IDå…¥åŠ›
      </button>
      <button onclick="closeActionSheet()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg">
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </button>
    </div>
  </div>

  <!-- ========== æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« ========== -->
  <div id="manualInputModal" class="hidden modal-overlay" onclick="closeManualModal(event)">
    <div class="bg-white rounded-xl p-6 max-w-sm w-full" onclick="event.stopPropagation()">
      <h3 class="text-xl font-bold text-gray-800 mb-4">æ¤ç‰©IDã‚’å…¥åŠ›</h3>
      <input 
        type="text" 
        id="manualIdInput" 
        placeholder="ä¾‹: A-01" 
        class="w-full p-3 border border-gray-300 rounded-lg mb-4 text-lg focus:outline-none focus:border-teal-500"
      />
      <div class="flex gap-3">
        <button onclick="closeManualModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 rounded-lg">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button id="manualSubmitBtn" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg">
          ç™»éŒ²
        </button>
      </div>
    </div>
  </div>

  <!-- ========== ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« ========== -->
  <div id="dataManagementModal" class="hidden modal-overlay" onclick="closeDataManagementModal(event)">
    <div class="bg-white rounded-xl p-6 max-w-sm w-full" onclick="event.stopPropagation()">
      <h3 class="text-xl font-bold text-gray-800 mb-4">âš™ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
      
      <div class="space-y-3">
        <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜ -->
        <button id="exportBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2">
          ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜
        </button>

        <!-- ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ -->
        <button id="importBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2">
          ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
        </button>

        <!-- å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ -->
        <button id="clearAllBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2">
          ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        </button>

        <div class="pt-3 border-t">
          <p class="text-xs text-gray-500 mb-2">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿æ•°: <span id="dataCount" class="font-bold">0</span>ä»¶</p>
        </div>
      </div>

      <button onclick="closeDataManagementModal()" class="w-full mt-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg">
        é–‰ã˜ã‚‹
      </button>
    </div>
  </div>

  <!-- ========== ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ ========== -->
  <div id="scanOverlay" class="overlay hidden">
    <!-- ã‚«ãƒ¡ãƒ©ãƒ“ãƒ¥ãƒ¼ -->
    <div class="flex-1 relative">
      <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
      <canvas id="canvas" class="hidden"></canvas>
      <div class="guide-frame">
        <div class="guide-text">ã‚¿ã‚°ã‚’ã“ã“ã«åã‚ã¦æ’®å½±</div>
      </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
    <div id="scanStatus" class="bg-black/80 text-white text-center py-3 px-4 text-sm font-bold">
      ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...
    </div>

    <!-- ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
    <div class="bg-black/90 p-4 flex gap-3">
      <button id="closeScanBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 rounded-lg text-lg">
        âœ• é–‰ã˜ã‚‹
      </button>
      <button id="captureBtn" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 rounded-lg text-lg">
        ğŸ“¸ æ’®å½±
      </button>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
    <details class="bg-black/90 px-4 pb-4">
      <summary class="cursor-pointer text-xs text-gray-400">ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±</summary>
      <div id="debugInfo" class="mt-2 bg-gray-800 text-gray-200 p-2 rounded text-xs whitespace-pre-wrap max-h-32 overflow-auto"></div>
    </details>
  </div>

  <!-- ========== éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› ========== -->
  <input type="file" id="imageFileInput" accept="image/*" capture="environment" class="hidden" />
  <input type="file" id="importFileInput" accept="application/json" class="hidden" />

  <script>
    // ========================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒ»å®šæ•°
    // ========================================
    const STORAGE_KEY = 'plantCycleData';
    const ALERT_DAYS = 7;
    let plants = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let cameraStream = null;
    let searchQuery = '';
    let currentImageTargetId = null;

    // DOMè¦ç´ 
    const fabBtn = document.getElementById('fabBtn');
    const actionSheetOverlay = document.getElementById('actionSheetOverlay');
    const actionSheet = document.getElementById('actionSheet');
    const cameraOptionBtn = document.getElementById('cameraOptionBtn');
    const manualOptionBtn = document.getElementById('manualOptionBtn');
    const manualInputModal = document.getElementById('manualInputModal');
    const manualIdInput = document.getElementById('manualIdInput');
    const manualSubmitBtn = document.getElementById('manualSubmitBtn');
    const scanOverlay = document.getElementById('scanOverlay');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const closeScanBtn = document.getElementById('closeScanBtn');
    const scanStatus = document.getElementById('scanStatus');
    const debugInfo = document.getElementById('debugInfo');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const plantListEl = document.getElementById('plantList');
    const emptyState = document.getElementById('emptyState');
    const imageFileInput = document.getElementById('imageFileInput');
    const settingsBtn = document.getElementById('settingsBtn');
    const dataManagementModal = document.getElementById('dataManagementModal');
    const dataCount = document.getElementById('dataCount');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const importFileInput = document.getElementById('importFileInput');

// ========================================
    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (YYYY/MM/DD)
    // ========================================
    const formatDate = (ts) => {
      if (!ts) return '---';
      const d = new Date(ts);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}/${month}/${day}`;
    };

    // ========================================
    // ä¿å­˜ãƒ»æç”»
    // ========================================
    const save = () => {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(plants));
        render();
      } catch (e) {
        alert('ãƒ‡ãƒ¼ã‚¿å®¹é‡ãŒã„ã£ã±ã„ã§ã™ã€‚å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚');
      }
    };

    // ========================================
    // ãƒ‡ãƒ¼ã‚¿ç®¡ç†æ©Ÿèƒ½
    // ========================================
    settingsBtn.addEventListener('click', () => {
      dataCount.textContent = plants.length;
      dataManagementModal.classList.remove('hidden');
    });

    window.closeDataManagementModal = (event) => {
      if (event && event.target !== dataManagementModal) return;
      dataManagementModal.classList.add('hidden');
    };

    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰
    exportBtn.addEventListener('click', () => {
      const dataStr = JSON.stringify(plants, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const today = new Date();
      const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
      a.href = url;
      a.download = `plants_backup_${dateStr}.json`;
      a.click();
      URL.revokeObjectURL(url);
      alert('âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    });

    // ãƒ‡ãƒ¼ã‚¿å¾©å…ƒï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰
    importBtn.addEventListener('click', () => {
      importFileInput.click();
    });

    importFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const importedData = JSON.parse(event.target.result);
          
          // ãƒ‡ãƒ¼ã‚¿å½¢å¼ãƒã‚§ãƒƒã‚¯
          if (!Array.isArray(importedData)) {
            alert('âŒ ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
            return;
          }

          // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
          if (confirm(`ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆ${plants.length}ä»¶ï¼‰ã¯ã™ã¹ã¦ä¸Šæ›¸ãã•ã‚Œã¾ã™ãŒã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
            plants = importedData;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(plants));
            alert(`âœ… ${plants.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ`);
            location.reload();
          }
        } catch (error) {
          console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
          alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    // å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
    clearAllBtn.addEventListener('click', () => {
      if (confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        if (confirm('æœ€çµ‚ç¢ºèªï¼šã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
          plants = [];
          localStorage.removeItem(STORAGE_KEY);
          alert('âœ… ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
          closeDataManagementModal();
          render();
        }
      }
    });

    // ========================================
    // ç”»åƒåœ§ç¸®ï¼ˆå…±é€šé–¢æ•°ï¼‰
    // ========================================
    const compressImage = (file, maxWidth = 300, quality = 0.5) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const scale = maxWidth / img.width;
            const width = scale < 1 ? maxWidth : img.width;
            const height = scale < 1 ? img.height * scale : img.height;
            
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    };

    const resizeAndCompressCanvas = (sourceCanvas, maxWidth = 300, quality = 0.5) => {
      const tempCanvas = document.createElement('canvas');
      const ctx = tempCanvas.getContext('2d');
      
      const scale = maxWidth / sourceCanvas.width;
      const width = scale < 1 ? maxWidth : sourceCanvas.width;
      const height = scale < 1 ? sourceCanvas.height * scale : sourceCanvas.height;
      
      tempCanvas.width = width;
      tempCanvas.height = height;
      ctx.drawImage(sourceCanvas, 0, 0, width, height);
      
      return tempCanvas.toDataURL('image/jpeg', quality);
    };

    // ========================================
    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒˆï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰
    // ========================================
    fabBtn.addEventListener('click', () => {
      actionSheetOverlay.classList.remove('hidden');
      actionSheet.classList.remove('hidden');
    });

    window.closeActionSheet = () => {
      actionSheetOverlay.classList.add('hidden');
      actionSheet.classList.add('hidden');
    };

    cameraOptionBtn.addEventListener('click', () => {
      closeActionSheet();
      openScanOverlay();
    });

    manualOptionBtn.addEventListener('click', () => {
      closeActionSheet();
      openManualModal();
    });

    // ========================================
    // æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«
    // ========================================
    const openManualModal = () => {
      manualInputModal.classList.remove('hidden');
      manualIdInput.value = '';
      manualIdInput.focus();
    };

    window.closeManualModal = (event) => {
      if (event && event.target !== manualInputModal) return;
      manualInputModal.classList.add('hidden');
    };

    manualSubmitBtn.addEventListener('click', () => {
      const id = manualIdInput.value.trim();
      if (!id) {
        alert('æ¤ç‰©IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const existing = plants.find(p => p.id === id);
      if (existing) {
        alert(`ID: ${id} ã¯æ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ã™`);
        closeManualModal();
        render();
        setTimeout(() => {
          const card = document.querySelector(`[data-plant-id="${id}"]`);
          if (card) {
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            card.classList.add('highlight-card');
            setTimeout(() => card.classList.remove('highlight-card'), 1500);
          }
        }, 300);
      } else {
        plants.unshift({ id, logs: [], image: null });
        save();
        closeManualModal();
      }
    });

    // ========================================
    // ã‚«ãƒ¡ãƒ©åˆ¶å¾¡
    // ========================================
    const startCamera = async () => {
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: "environment",
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          } 
        });
        video.srcObject = cameraStream;
        scanStatus.textContent = "âœ… ã‚¿ã‚°ã‚’æ’®å½±ã—ã¦ãã ã•ã„";
        scanStatus.className = "bg-green-600 text-white text-center py-3 px-4 text-sm font-bold";
      } catch (err) {
        console.error("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:", err);
        scanStatus.textContent = "âŒ ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ";
        scanStatus.className = "bg-red-600 text-white text-center py-3 px-4 text-sm font-bold";
      }
    };

    const stopCamera = () => {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
    };

    const openScanOverlay = () => {
      scanOverlay.classList.remove('hidden');
      startCamera();
    };

    closeScanBtn.addEventListener('click', () => {
      scanOverlay.classList.add('hidden');
      stopCamera();
      scanStatus.textContent = "ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...";
      scanStatus.className = "bg-black/80 text-white text-center py-3 px-4 text-sm font-bold";
    });

    // ========================================
    // æ’®å½±ãƒ»AIè§£æ
    // ========================================
    captureBtn.addEventListener('click', async () => {
      const context = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      scanStatus.textContent = "â³ AIã§è§£æä¸­...";
      scanStatus.className = "bg-yellow-600 text-white text-center py-3 px-4 text-sm font-bold";
      captureBtn.disabled = true;

      try {
        const imageBase64 = canvas.toDataURL('image/jpeg', 0.95);
        debugInfo.textContent = "ğŸ“¤ ç”»åƒã‚’é€ä¿¡ä¸­...\nç”»åƒã‚µã‚¤ã‚º: " + Math.round(imageBase64.length / 1024) + " KB";
        
        const response = await fetch('/api/scan-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageBase64 })
        });

        const result = await response.json();
        debugInfo.textContent = "ğŸ“¥ Geminiã‹ã‚‰ã®è¿”ç­”:\n" + JSON.stringify(result, null, 2);
        
        if (result.id && result.id !== "NOT_FOUND") {
          const detectedId = result.id;
          const existing = plants.find(p => p.id === detectedId);

          if (existing) {
            // ç™»éŒ²æ¸ˆã¿ï¼šç”»åƒã¯ä¿å­˜ã—ãªã„
            scanStatus.textContent = `âœ… ç™»éŒ²æ¸ˆã¿ã§ã™: ${detectedId}`;
            scanStatus.className = "bg-green-600 text-white text-center py-3 px-4 text-sm font-bold";
            
            setTimeout(() => {
              scanOverlay.classList.add('hidden');
              stopCamera();
              
              render();
              setTimeout(() => {
                const card = document.querySelector(`[data-plant-id="${detectedId}"]`);
                if (card) {
                  card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  card.classList.add('highlight-card');
                  setTimeout(() => card.classList.remove('highlight-card'), 1500);
                }
              }, 300);
            }, 1500);
            
          } else {
            // æ–°è¦ï¼šç”»åƒã‚’åœ§ç¸®ã—ã¦ä¿å­˜
            scanStatus.textContent = `ğŸ†• æ–°è¦IDæ¤œå‡º: ${detectedId}`;
            scanStatus.className = "bg-blue-600 text-white text-center py-3 px-4 text-sm font-bold";
            
            if (confirm(`æ–°è¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\nID: ${detectedId}`)) {
              const compressedImage = resizeAndCompressCanvas(canvas, 300, 0.5);
              
              plants.unshift({ 
                id: detectedId, 
                logs: [], 
                image: compressedImage 
              });
              save();
              
              scanStatus.textContent = "âœ… æ–°è¦ç™»éŒ²å®Œäº†ï¼";
              scanStatus.className = "bg-green-600 text-white text-center py-3 px-4 text-sm font-bold";
              
              setTimeout(() => {
                scanOverlay.classList.add('hidden');
                stopCamera();
              }, 1500);
            } else {
              scanStatus.textContent = "âŒ ç™»éŒ²ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ";
              scanStatus.className = "bg-gray-600 text-white text-center py-3 px-4 text-sm font-bold";
            }
          }
        } else {
          scanStatus.textContent = "âš ï¸ IDã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ";
          scanStatus.className = "bg-red-600 text-white text-center py-3 px-4 text-sm font-bold";
        }
      } catch (error) {
        console.error("è§£æã‚¨ãƒ©ãƒ¼:", error);
        debugInfo.textContent = "âŒ ã‚¨ãƒ©ãƒ¼:\n" + error.toString();
        scanStatus.textContent = "âŒ è§£æã«å¤±æ•—ã—ã¾ã—ãŸ";
        scanStatus.className = "bg-red-600 text-white text-center py-3 px-4 text-sm font-bold";
      }
      
      captureBtn.disabled = false;
    });

    // ========================================
    // ç”»åƒã®æ‰‹å‹•ç™»éŒ²/å¤‰æ›´
    // ========================================
    window.openImageUpload = (id) => {
      currentImageTargetId = id;
      imageFileInput.click();
    };

    imageFileInput.addEventListener('change', async (e) => {
      if (!e.target.files || !e.target.files[0] || !currentImageTargetId) return;
      
      const file = e.target.files[0];
      const plant = plants.find(p => p.id === currentImageTargetId);
      
      if (plant) {
        try {
          const compressedImage = await compressImage(file, 300, 0.5);
          plant.image = compressedImage;
          save();
        } catch (error) {
          console.error('ç”»åƒåœ§ç¸®ã‚¨ãƒ©ãƒ¼:', error);
          alert('ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }
      
      e.target.value = '';
      currentImageTargetId = null;
    });

    // ========================================
    // æ¤ç‰©ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯
    // ========================================
    window.addLog = (id, type) => {
      const plant = plants.find(p => p.id === id);
      if (!plant) return;
      const today = new Date();
      const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
      const timestamp = today.getTime();
      plant.logs.unshift({ type, date: dateStr, ts: timestamp });
      if (plant.logs.length > 50) plant.logs.pop();
      save();
    };

    window.deletePlant = (id) => {
      if (!confirm(`ID: ${id} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      plants = plants.filter(p => p.id !== id);
      save();
    };

    const calculateDaysAgo = (log) => {
      if (!log) return null;
      if (log.ts) {
        const diff = Date.now() - log.ts;
        return Math.floor(diff / (1000 * 60 * 60 * 24));
      }
      try {
        const now = new Date();
        const [m, d] = log.date.split('/').map(Number);
        const logDate = new Date(now.getFullYear(), m - 1, d);
        if (logDate > now) logDate.setFullYear(now.getFullYear() - 1);
        const diff = now - logDate;
        return Math.floor(diff / (1000 * 60 * 60 * 24));
      } catch (e) {
        return null;
      }
    };

    const getDaysAgoHtml = (log) => {
      const days = calculateDaysAgo(log);
      if (days === null) return '';
      if (days === 0) return '<span class="text-teal-600 font-bold ml-1">(ä»Šæ—¥)</span>';
      return `<span class="text-gray-500 font-bold ml-1">(${days}æ—¥å‰)</span>`;
    };

    const isAlertNeeded = (plant) => {
      const lastWaterLog = plant.logs.find(l => l.type === 'æ°´');
      if (!lastWaterLog) return false;
      const days = calculateDaysAgo(lastWaterLog);
      return days !== null && days >= ALERT_DAYS;
    };

    const sortPlants = (plantsList) => {
      const sortType = sortSelect.value;
      const sorted = [...plantsList];

      if (sortType === 'created') {
        return sorted;
      } else if (sortType === 'id') {
        return sorted.sort((a, b) => a.id.localeCompare(b.id));
      } else if (sortType === 'alert') {
        return sorted.sort((a, b) => {
          const aDanger = isAlertNeeded(a);
          const bDanger = isAlertNeeded(b);
          if (aDanger && !bDanger) return -1;
          if (!aDanger && bDanger) return 1;
          const aLog = a.logs.find(l => l.type === 'æ°´');
          const bLog = b.logs.find(l => l.type === 'æ°´');
          const aTime = aLog ? (aLog.ts || 0) : 0;
          const bTime = bLog ? (bLog.ts || 0) : 0;
          return aTime - bTime;
        });
      }
      return sorted;
    };

    const filterPlants = (plantsList) => {
      if (!searchQuery) return plantsList;
      return plantsList.filter(p => p.id.toLowerCase().includes(searchQuery.toLowerCase()));
    };

    // ========================================
    // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰
    // ========================================
    window.toggleAccordion = (id) => {
      const content = document.getElementById(`accordion-${id}`);
      const arrow = document.getElementById(`arrow-${id}`);
      
      content.classList.toggle('expanded');
      arrow.classList.toggle('rotated');
    };

    // ========================================
    // å¹³å‡æ°´ã‚„ã‚Šé–“éš”ã®è¨ˆç®—
    // ========================================
    const calculateAverageInterval = (plant) => {
      const waterLogs = plant.logs.filter(l => l.type === 'æ°´');
      if (waterLogs.length < 2) return null;
      
      let totalDays = 0;
      let count = 0;
      
      for (let i = 0; i < waterLogs.length - 1; i++) {
        const days1 = calculateDaysAgo(waterLogs[i]);
        const days2 = calculateDaysAgo(waterLogs[i + 1]);
        if (days1 !== null && days2 !== null) {
          totalDays += Math.abs(days2 - days1);
          count++;
        }
      }
      
      return count > 0 ? Math.round(totalDays / count) : null;
    };

    const render = () => {
      const filteredPlants = filterPlants(plants);
      const sortedPlants = sortPlants(filteredPlants);

      plantListEl.innerHTML = '';

      if (sortedPlants.length === 0) {
        emptyState.classList.remove('hidden');
        return;
      } else {
        emptyState.classList.add('hidden');
      }

      sortedPlants.forEach(plant => {
        const isDanger = isAlertNeeded(plant);
        const cardClass = isDanger 
          ? 'bg-red-50 rounded-xl shadow-md border-2 border-red-400 overflow-hidden'
          : 'bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden';

        // --- ãƒ‡ãƒ¼ã‚¿åŠ å·¥ãƒ­ã‚¸ãƒƒã‚¯ ---
        // ãƒ­ã‚°ã‚’æ–°ã—ã„é †ï¼ˆtsã®é™é †ï¼‰ã«ã‚½ãƒ¼ãƒˆ
        const sortedLogs = plant.logs ? [...plant.logs].sort((a, b) => b.ts - a.ts) : [];
        // ã€Œæ°´ã€ã®ãƒ­ã‚°ã ã‘æŠ½å‡º
        const waterLogs = sortedLogs.filter(l => l.type === 'æ°´');

        // è¡¨ç¤ºç”¨ãƒ‡ãƒ¼ã‚¿ã®æº–å‚™
        const lastWaterLog = waterLogs[0];
        const secondLastWaterLog = waterLogs[1];

        // ãƒ˜ãƒƒãƒ€ãƒ¼ç”¨æ—¥ä»˜ (ä¾‹: 2026/01/29)
        const headerDateText = lastWaterLog ? formatDate(lastWaterLog.ts) : 'æœªè¨˜éŒ²';
        
        // è©³ç´°ãƒªã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿
        const lastDateFull = lastWaterLog ? formatDate(lastWaterLog.ts) : '---';
        const secondDateFull = secondLastWaterLog ? formatDate(secondLastWaterLog.ts) : '---';
        
        // å¹³å‡ãƒšãƒ¼ã‚¹
        const avgInterval = calculateAverageInterval(plant);
        const avgText = avgInterval ? `${avgInterval}æ—¥` : '---';

        const card = document.createElement('div');
        card.className = cardClass;
        card.dataset.plantId = plant.id;
        
        // --- HTMLç”Ÿæˆ ---
        card.innerHTML = `
          <div class="accordion-header p-4 flex items-center justify-between bg-white" onclick="toggleAccordion('${plant.id}')">
            <div class="flex items-center gap-3">
              <div class="flex-shrink-0 text-xl">
                ${isDanger ? 'âš ï¸' : 'ğŸŒ¿'}
              </div>
              <div class="flex flex-col">
                <span class="font-bold text-gray-800 text-lg leading-tight">${plant.id}</span>
                <span class="text-xs text-gray-500 mt-1">å‰å›: ${headerDateText}</span>
              </div>
            </div>
            <div id="arrow-${plant.id}" class="arrow-icon text-gray-400 text-xl">â–¼</div>
          </div>

          <div id="accordion-${plant.id}" class="accordion-content bg-gray-50">
            <div class="p-4 border-t border-gray-200">
              
              <div onclick="event.stopPropagation(); openImageUpload('${plant.id}')" class="w-full h-40 mb-4 cursor-pointer hover:opacity-90 transition rounded-lg overflow-hidden border border-gray-200 bg-white relative group">
                ${plant.image 
                  ? `<img src="${plant.image}" class="w-full h-full object-cover" alt="${plant.id}">`
                  : `<div class="w-full h-full flex flex-col items-center justify-center text-gray-400 text-sm">
                       <span class="text-3xl mb-2">ğŸ“·</span>
                       <span>å†™çœŸã‚’ç™»éŒ²</span>
                     </div>`
                }
                <div class="absolute bottom-0 right-0 bg-black/50 text-white text-xs px-2 py-1 m-2 rounded opacity-0 group-hover:opacity-100 transition">å¤‰æ›´</div>
              </div>

              <div class="bg-white rounded-lg border border-gray-200 px-4 py-1 mb-5 shadow-sm">
                <div class="stats-row">
                  <span class="stats-label">å‰å›</span>
                  <span class="stats-value text-teal-700">${lastDateFull}</span>
                </div>
                <div class="stats-row">
                  <span class="stats-label">å‰ã€…å›</span>
                  <span class="stats-value">${secondDateFull}</span>
                </div>
                <div class="stats-row">
                  <span class="stats-label">å¹³å‡ãƒšãƒ¼ã‚¹</span>
                  <span class="stats-value">${avgText}</span>
                </div>
              </div>

              <div class="grid grid-cols-3 gap-3 mb-4">
                <button onclick="event.stopPropagation(); addLog('${plant.id}', 'æ¶²è‚¥')" class="bg-orange-100 hover:bg-orange-200 text-orange-700 font-bold py-3 text-sm rounded-lg border border-orange-200 active:scale-95 transition flex flex-col items-center gap-1">
                  <span>ğŸ’Š</span>æ¶²è‚¥
                </button>
                <button onclick="event.stopPropagation(); addLog('${plant.id}', 'æ°´')" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 text-sm rounded-lg shadow-md active:scale-95 transition flex flex-col items-center gap-1 transform scale-105">
                  <span>ğŸ’§</span>æ°´ã‚„ã‚Š
                </button>
                <button onclick="event.stopPropagation(); addLog('${plant.id}', 'æ´»åŠ›å‰¤')" class="bg-yellow-100 hover:bg-yellow-200 text-yellow-700 font-bold py-3 text-sm rounded-lg border border-yellow-200 active:scale-95 transition flex flex-col items-center gap-1">
                  <span>âš¡</span>æ´»åŠ›å‰¤
                </button>
              </div>

              <div class="text-right">
                <button onclick="event.stopPropagation(); deletePlant('${plant.id}')" class="delete-link">
                  ğŸ—‘ï¸ ã“ã®æ¤ç‰©ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                </button>
              </div>

            </div>
          </div>
        `;
        plantListEl.appendChild(card);
      });
    };

    // ========================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    // ========================================
    searchInput.addEventListener('input', (e) => {
      searchQuery = e.target.value;
      render();
    });

    sortSelect.addEventListener('change', () => {
      render();
    });

    // åˆæœŸæç”»
    render();
  </script>

</body>
</html>
