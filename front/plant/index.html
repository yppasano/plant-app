<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Cycle Monitor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    /* ã‚¬ã‚¤ãƒ‰ãƒ•ãƒ¬ãƒ¼ãƒ  */
    .guide-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 200px;
      border: 3px dashed #2dd4bf; /* teal-400 */
      border-radius: 12px;
      pointer-events: none;
      background: rgba(45, 212, 191, 0.1);
    }
    .guide-text {
      position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      background: #0f766e; /* teal-700 */
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
      white-space: nowrap;
      box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }
    /* FAB */
    .fab {
      position: fixed;
      right: 20px;
      bottom: 80px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.5);
      z-index: 40;
      transition: transform 0.2s;
    }
    .fab:active {
      transform: scale(0.95);
    }
    /* ãƒ¢ãƒ¼ãƒ€ãƒ«é¡ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(2px);
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .action-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: #1f2937; /* gray-800 */
      border-radius: 20px 20px 0 0;
      z-index: 50;
      animation: slideUp 0.3s ease-out;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.5);
      border-top: 1px solid #374151;
    }
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    .highlight-card {
      animation: highlight 1.5s ease-in-out;
    }
    @keyframes highlight {
      0%, 100% { background-color: #1f2937; } /* gray-800 */
      50% { background-color: #115e59; } /* teal-800 */
    }
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .accordion-content.expanded {
      max-height: 800px;
      transition: max-height 0.4s ease-in;
    }
    .arrow-icon {
      transition: transform 0.3s ease;
    }
    .arrow-icon.rotated {
      transform: rotate(180deg);
    }
    .delete-link:hover {
      color: #f87171; /* red-400 */
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 pb-28 antialiased selection:bg-teal-500 selection:text-white">

  <div id="mainScreen" class="max-w-md mx-auto min-h-screen bg-gray-900 relative">
    
    <header class="bg-gray-900 border-b border-gray-800 p-4 flex justify-between items-center">
      <h1 class="text-xl font-bold tracking-wider flex items-center gap-2">
        <span class="text-2xl">ğŸŒ¿</span>
        <span class="bg-clip-text text-transparent bg-gradient-to-r from-teal-400 to-emerald-400">Cycle Monitor</span>
      </h1>
      <button id="settingsBtn" class="text-2xl text-gray-400 hover:text-teal-400 transition p-2 rounded-full hover:bg-gray-800">âš™ï¸</button>
    </header>

    <div class="p-4 bg-gray-900">
      <div class="relative">
        <span class="absolute left-3 top-3 text-gray-500">ğŸ”</span>
        <input 
          type="text" 
          id="searchInput" 
          placeholder="ID search..." 
          class="w-full pl-10 p-3 bg-gray-800 border border-gray-700 rounded-xl text-gray-200 placeholder-gray-600 focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 transition"
        />
      </div>
    </div>

    <div class="px-4 pb-2 flex justify-between items-center">
      <span class="text-xs text-gray-500 font-bold uppercase tracking-wider">Sort By</span>
      <div class="relative">
        <select id="sortSelect" class="appearance-none bg-gray-800 border border-gray-700 text-teal-400 text-xs font-bold rounded-lg py-2 pl-3 pr-8 focus:border-teal-500 outline-none cursor-pointer hover:bg-gray-750 transition">
          <option value="created">â–¼ Newest</option>
          <option value="id">ğŸ”¤ ID (A-Z)</option>
          <option value="alert">âš ï¸ Alert Priority</option>
          <option value="dry_slow">ğŸ¢ Slow Dry</option>
          <option value="dry_fast">ğŸ‡ Fast Dry</option>
        </select>
        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
          <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
        </div>
      </div>
    </div>

    <div id="plantList" class="p-4 space-y-4"></div>

    <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20 text-gray-600">
      <div class="text-6xl mb-4 opacity-20">ğŸŒ±</div>
      <p class="text-lg font-medium text-gray-500">No Plants Registered</p>
      <p class="text-sm mt-2">Tap + to add one</p>
    </div>
  </div>

  <button id="fabBtn" class="fab bg-teal-600 hover:bg-teal-500 text-white shadow-lg shadow-teal-900/50 transition transform hover:scale-110">
    ï¼‹
  </button>

  <div id="actionSheetOverlay" class="hidden fixed inset-0 bg-black/50 z-40" onclick="closeActionSheet()"></div>
  <div id="actionSheet" class="hidden action-sheet">
    <div class="p-6 space-y-4">
      <h3 class="text-lg font-bold text-gray-300 mb-2 text-center">Add New Plant</h3>
      <button id="cameraOptionBtn" class="w-full bg-teal-700 hover:bg-teal-600 text-white font-bold py-4 rounded-xl text-lg flex items-center justify-center gap-2 shadow-lg transition">
        ğŸ“· Camera Scan
      </button>
      <button id="manualOptionBtn" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-200 font-bold py-4 rounded-xl text-lg flex items-center justify-center gap-2 border border-gray-600 transition">
        âŒ¨ï¸ Manual Input
      </button>
      <button onclick="closeActionSheet()" class="w-full bg-gray-800 text-gray-500 font-bold py-3 rounded-xl mt-2 border border-gray-700">
        Cancel
      </button>
    </div>
  </div>

  <div id="manualInputModal" class="hidden modal-overlay" onclick="closeManualModal(event)">
    <div class="bg-gray-800 rounded-2xl p-6 max-w-sm w-full border border-gray-700 shadow-2xl" onclick="event.stopPropagation()">
      <h3 class="text-xl font-bold text-gray-100 mb-4">Enter Plant ID</h3>
      <input 
        type="text" 
        id="manualIdInput" 
        placeholder="e.g. A-01" 
        class="w-full p-4 bg-gray-900 border border-gray-600 rounded-xl mb-6 text-lg text-white focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 placeholder-gray-600"
      />
      <div class="flex gap-3">
        <button onclick="closeManualModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 text-gray-300 font-bold py-3 rounded-xl border border-gray-600">
          Cancel
        </button>
        <button id="manualSubmitBtn" class="flex-1 bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 rounded-xl shadow-lg">
          Add
        </button>
      </div>
    </div>
  </div>

  <div id="dataManagementModal" class="hidden modal-overlay" onclick="closeDataManagementModal(event)">
    <div class="bg-gray-800 rounded-2xl p-6 max-w-sm w-full border border-gray-700 shadow-2xl" onclick="event.stopPropagation()">
      <h3 class="text-xl font-bold text-gray-100 mb-6 flex items-center gap-2">
        <span>âš™ï¸</span> Settings
      </h3>
      
      <div class="space-y-3">
        <button id="exportBtn" class="w-full bg-blue-900/40 hover:bg-blue-800/60 text-blue-200 border border-blue-800 font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition">
          ğŸ“¥ Backup Data
        </button>

        <button id="importBtn" class="w-full bg-green-900/40 hover:bg-green-800/60 text-green-200 border border-green-800 font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition">
          ğŸ“¤ Restore Data
        </button>

        <button id="clearAllBtn" class="w-full bg-red-900/40 hover:bg-red-800/60 text-red-200 border border-red-800 font-bold py-3 rounded-xl flex items-center justify-center gap-2 transition mt-4">
          ğŸ—‘ï¸ Delete All Data
        </button>

        <div class="pt-4 border-t border-gray-700 mt-2">
          <p class="text-xs text-gray-500 text-center">Total Plants: <span id="dataCount" class="font-bold text-teal-400 text-base">0</span></p>
        </div>
      </div>

      <button onclick="closeDataManagementModal()" class="w-full mt-6 bg-gray-900 text-gray-500 font-bold py-3 rounded-xl border border-gray-700">
        Close
      </button>
    </div>
  </div>

  <div id="scanOverlay" class="fixed inset-0 bg-black z-50 hidden">
    <div class="absolute inset-0 z-0">
      <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
      <canvas id="canvas" class="hidden"></canvas>
      <div class="guide-frame">
        <div class="guide-text">ã‚¿ã‚°ã‚’ã“ã“ã«åã‚ã¦æ’®å½±</div>
      </div>
    </div>
    <div class="absolute bottom-0 left-0 right-0 z-10 flex flex-col px-4 pb-6 pt-12 bg-gradient-to-t from-black via-black/90 to-transparent">
      <div id="scanStatus" class="mb-4 bg-black/60 backdrop-blur-md text-white text-center py-2 px-4 rounded-full text-sm font-bold border border-white/20 shadow-lg mx-auto">
        ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...
      </div>
      <div class="flex gap-3 mb-2">
        <button id="closeScanBtn" class="flex-1 bg-gray-600/90 hover:bg-gray-700 text-white font-bold py-4 rounded-xl text-lg shadow-lg backdrop-blur-sm border border-white/10 active:scale-95 transition">
          âœ• é–‰ã˜ã‚‹
        </button>
        <button id="captureBtn" class="flex-1 bg-teal-600/90 hover:bg-teal-700 text-white font-bold py-4 rounded-xl text-lg shadow-lg backdrop-blur-sm border border-white/10 active:scale-95 transition">
          ğŸ“¸ æ’®å½±
        </button>
      </div>
      <details class="mt-2">
        <summary class="cursor-pointer text-xs text-gray-400 text-center py-2 opacity-70">ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º</summary>
        <div id="debugInfo" class="mt-1 bg-gray-900/90 text-gray-200 p-3 rounded-lg text-xs whitespace-pre-wrap max-h-24 overflow-auto border border-gray-700 shadow-inner"></div>
      </details>
      <div class="h-[env(safe-area-inset-bottom)]"></div>
    </div>
  </div>

  <input type="file" id="imageFileInput" accept="image/*" class="hidden" />
  <input type="file" id="importFileInput" accept="application/json" class="hidden" />

  <script>
    // ========================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒ»å®šæ•°
    // ========================================
    const STORAGE_KEY = 'plantCycleData';
    const ALERT_DAYS = 7;
    let plants = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let cameraStream = null;
    let searchQuery = '';
    let currentImageTargetId = null;

    // ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯ (è‡ªåˆ†å°‚ç”¨ãƒ­ãƒƒã‚¯)
    const MY_PASSWORD = "1202"; 
    const LOCK_KEY = "app_unlocked";
    const checkLock = () => {
      const isUnlocked = sessionStorage.getItem(LOCK_KEY);
      if (isUnlocked !== "true") {
        // ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰å…¥åŠ›ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚‚ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã«ã¯ã§ããªã„ãŸã‚ã€ãƒ–ãƒ©ã‚¦ã‚¶æ¨™æº–ã®ã‚‚ã®ã‚’ä½¿ç”¨
        const input = prompt("Password Required:");
        if (input === MY_PASSWORD) {
          sessionStorage.setItem(LOCK_KEY, "true");
        } else {
          document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;background:#111;color:#f00;font-weight:bold;">â›” ACCESS DENIED</div>';
          throw new Error("Access Denied");
        }
      }
    };
    checkLock();
    
    // DOMè¦ç´ 
    const fabBtn = document.getElementById('fabBtn');
    const actionSheetOverlay = document.getElementById('actionSheetOverlay');
    const actionSheet = document.getElementById('actionSheet');
    const cameraOptionBtn = document.getElementById('cameraOptionBtn');
    const manualOptionBtn = document.getElementById('manualOptionBtn');
    const manualInputModal = document.getElementById('manualInputModal');
    const manualIdInput = document.getElementById('manualIdInput');
    const manualSubmitBtn = document.getElementById('manualSubmitBtn');
    const scanOverlay = document.getElementById('scanOverlay');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const closeScanBtn = document.getElementById('closeScanBtn');
    const scanStatus = document.getElementById('scanStatus');
    const debugInfo = document.getElementById('debugInfo');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const plantListEl = document.getElementById('plantList');
    const emptyState = document.getElementById('emptyState');
    const imageFileInput = document.getElementById('imageFileInput');
    const settingsBtn = document.getElementById('settingsBtn');
    const dataManagementModal = document.getElementById('dataManagementModal');
    const dataCount = document.getElementById('dataCount');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const importFileInput = document.getElementById('importFileInput');

    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
    const formatDate = (ts) => {
      if (!ts) return '---';
      const d = new Date(ts);
      return `${d.getFullYear()}/${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
    };

    // ä¿å­˜
    const save = () => {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(plants));
        render();
      } catch (e) {
        alert('Storage Full');
      }
    };

    // ãƒ­ã‚°è¡¨ç¤ºç”¨ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆï¼ˆãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼‰
    const formatLogDisplay = (log) => {
      if (!log) return '---';
      
      const date = formatDate(log.ts);
      let icon = '';
      
      switch (log.type) {
        case 'æ°´': icon = 'ğŸ’§'; break;
        case 'æ¶²è‚¥': icon = 'ğŸ’Š'; break;
        case 'æ´»åŠ›å‰¤': icon = 'âš¡'; break;
        default: icon = 'ğŸ“';
      }

      // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚¿ã‚°ã‚¹ã‚¿ã‚¤ãƒ«
      return `<span class="mr-2 font-mono text-gray-400">${date}</span><span class="text-xs bg-gray-700 text-gray-200 px-2 py-0.5 rounded border border-gray-600">${icon} ${log.type}</span>`;
    };

    // ========================================
    // ãƒ‡ãƒ¼ã‚¿ç®¡ç†
    // ========================================
    settingsBtn.addEventListener('click', () => {
      dataCount.textContent = plants.length;
      dataManagementModal.classList.remove('hidden');
    });
    window.closeDataManagementModal = (event) => {
      if (event && event.target !== dataManagementModal) return;
      dataManagementModal.classList.add('hidden');
    };
    exportBtn.addEventListener('click', () => {
      const dataStr = JSON.stringify(plants, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const today = new Date();
      const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
      a.href = url;
      a.download = `plants_backup_${dateStr}.json`;
      a.click();
      URL.revokeObjectURL(url);
    });
    importBtn.addEventListener('click', () => importFileInput.click());
    importFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const importedData = JSON.parse(event.target.result);
          if (confirm(`Overwrite current data with ${importedData.length} records?`)) {
            plants = importedData;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(plants));
            location.reload();
          }
        } catch (error) {
          alert('Import Failed');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    });
    clearAllBtn.addEventListener('click', () => {
      if (confirm('Delete ALL data? This cannot be undone.')) {
        plants = [];
        localStorage.removeItem(STORAGE_KEY);
        closeDataManagementModal();
        render();
      }
    });

    // ========================================
    // ç”»åƒåœ§ç¸®
    // ========================================
    const compressImage = (file, maxWidth = 300, quality = 0.5) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const scale = maxWidth / img.width;
            const width = scale < 1 ? maxWidth : img.width;
            const height = scale < 1 ? img.height * scale : img.height;
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    };
    const resizeAndCompressCanvas = (sourceCanvas, maxWidth = 300, quality = 0.5) => {
      const tempCanvas = document.createElement('canvas');
      const ctx = tempCanvas.getContext('2d');
      const scale = maxWidth / sourceCanvas.width;
      const width = scale < 1 ? maxWidth : sourceCanvas.width;
      const height = scale < 1 ? sourceCanvas.height * scale : sourceCanvas.height;
      tempCanvas.width = width;
      tempCanvas.height = height;
      ctx.drawImage(sourceCanvas, 0, 0, width, height);
      return tempCanvas.toDataURL('image/jpeg', quality);
    };

    // ========================================
    // UIæ“ä½œ (FAB, Modal)
    // ========================================
    fabBtn.addEventListener('click', () => {
      actionSheetOverlay.classList.remove('hidden');
      actionSheet.classList.remove('hidden');
    });
    window.closeActionSheet = () => {
      actionSheetOverlay.classList.add('hidden');
      actionSheet.classList.add('hidden');
    };
    cameraOptionBtn.addEventListener('click', () => {
      closeActionSheet();
      openScanOverlay();
    });
    manualOptionBtn.addEventListener('click', () => {
      closeActionSheet();
      openManualModal();
    });
    const openManualModal = () => {
      manualInputModal.classList.remove('hidden');
      manualIdInput.value = '';
      manualIdInput.focus();
    };
    window.closeManualModal = (event) => {
      if (event && event.target !== manualInputModal) return;
      manualInputModal.classList.add('hidden');
    };
    manualSubmitBtn.addEventListener('click', () => {
      const id = manualIdInput.value.trim();
      if (!id) return;
      const existing = plants.find(p => p.id === id);
      if (existing) {
        alert(`ID: ${id} already exists`);
        closeManualModal();
        render();
      } else {
        plants.unshift({ id, logs: [], image: null });
        save();
        closeManualModal();
      }
    });

    // ========================================
    // ã‚«ãƒ¡ãƒ©ãƒ»AI
    // ========================================
    const startCamera = async () => {
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: "environment", width: { ideal: 1920 }, height: { ideal: 1080 } } 
        });
        video.srcObject = cameraStream;
        scanStatus.textContent = "âœ… Ready to scan";
        scanStatus.className = "bg-green-600 text-white text-center py-3 px-4 text-sm font-bold";
      } catch (err) {
        scanStatus.textContent = "âŒ Camera Error";
      }
    };
    const stopCamera = () => {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
    };
    const openScanOverlay = () => {
      scanOverlay.classList.remove('hidden');
      startCamera();
    };
    closeScanBtn.addEventListener('click', () => {
      scanOverlay.classList.add('hidden');
      stopCamera();
    });
    captureBtn.addEventListener('click', async () => {
      const context = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);
      scanStatus.textContent = "â³ Analyzing...";
      scanStatus.className = "bg-yellow-600 text-white text-center py-3 px-4 text-sm font-bold";
      captureBtn.disabled = true;

      try {
        const imageBase64 = canvas.toDataURL('image/jpeg', 0.95);
        debugInfo.textContent = "Sending image...";
        const response = await fetch('/api/scan-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageBase64 })
        });
        const result = await response.json();
        debugInfo.textContent = "Result: " + JSON.stringify(result);
        
        if (result.id && result.id !== "NOT_FOUND") {
          const detectedId = result.id;
          const existing = plants.find(p => p.id === detectedId);
          if (existing) {
            scanStatus.textContent = `âœ… Found: ${detectedId}`;
            scanStatus.className = "bg-green-600 text-white text-center py-3 px-4 text-sm font-bold";
            setTimeout(() => {
              scanOverlay.classList.add('hidden');
              stopCamera();
              render();
            }, 1000);
          } else {
            scanStatus.textContent = `ğŸ†• New: ${detectedId}`;
            scanStatus.className = "bg-blue-600 text-white text-center py-3 px-4 text-sm font-bold";
            if (confirm(`Register new plant?\nID: ${detectedId}`)) {
              const compressedImage = resizeAndCompressCanvas(canvas, 300, 0.5);
              plants.unshift({ id: detectedId, logs: [], image: compressedImage });
              save();
              setTimeout(() => {
                scanOverlay.classList.add('hidden');
                stopCamera();
              }, 1000);
            }
          }
        } else {
          scanStatus.textContent = "âš ï¸ Not recognized";
          scanStatus.className = "bg-red-600 text-white text-center py-3 px-4 text-sm font-bold";
        }
      } catch (error) {
        scanStatus.textContent = "âŒ Error";
      }
      captureBtn.disabled = false;
    });

    // ========================================
    // ãƒ­ã‚¸ãƒƒã‚¯ (ç”»åƒç™»éŒ²ãƒ»è¿½åŠ ãƒ»å‰Šé™¤)
    // ========================================
    window.openImageUpload = (id) => {
      currentImageTargetId = id;
      imageFileInput.click();
    };
    imageFileInput.addEventListener('change', async (e) => {
      if (!e.target.files || !e.target.files[0] || !currentImageTargetId) return;
      try {
        const compressedImage = await compressImage(e.target.files[0], 300, 0.5);
        const plant = plants.find(p => p.id === currentImageTargetId);
        if (plant) { plant.image = compressedImage; save(); }
      } catch (e) {}
      e.target.value = '';
    });
    window.addLog = (id, type) => {
      const plant = plants.find(p => p.id === id);
      if (!plant) return;
      const today = new Date();
      plant.logs.unshift({ type, date: `${today.getMonth()+1}/${today.getDate()}`, ts: today.getTime() });
      if (plant.logs.length > 50) plant.logs.pop();
      save();
    };
    window.deletePlant = (id) => {
      if (confirm(`Delete ${id}?`)) {
        plants = plants.filter(p => p.id !== id);
        save();
      }
    };

    // ========================================
    // åˆ†æãƒ­ã‚¸ãƒƒã‚¯ (æ—¥æ•°ãƒ»å¹³å‡)
    // ========================================
    const calculateDaysAgo = (log) => {
      if (!log || !log.ts) return null;
      const diff = Date.now() - log.ts;
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    };
    const isAlertNeeded = (plant) => {
      const lastWaterLog = plant.logs.find(l => l.type === 'æ°´');
      if (!lastWaterLog) return false;
      const days = calculateDaysAgo(lastWaterLog);
      return days !== null && days >= ALERT_DAYS;
    };
    const calculateAverageInterval = (plant) => {
      const targetTypes = ['æ°´', 'æ¶²è‚¥', 'æ´»åŠ›å‰¤'];
      const validLogs = plant.logs.filter(l => targetTypes.includes(l.type));
      if (validLogs.length < 2) return null;
      const sortedLogs = [...validLogs].sort((a, b) => b.ts - a.ts);
      let totalDays = 0;
      let count = 0;
      for (let i = 0; i < sortedLogs.length - 1; i++) {
        const days1 = calculateDaysAgo(sortedLogs[i]);
        const days2 = calculateDaysAgo(sortedLogs[i + 1]);
        if (days1 !== null && days2 !== null) {
          const diff = Math.abs(days2 - days1);
          if (diff >= 1) { // 24æ™‚é–“æœªæº€ã¯é™¤å¤–
            totalDays += diff;
            count++;
          }
        }
      }
      return count > 0 ? Math.round(totalDays / count) : null;
    };

    // ========================================
    // ã‚½ãƒ¼ãƒˆ & ãƒ•ã‚£ãƒ«ã‚¿
    // ========================================
    const sortPlants = (plantsList) => {
      const sortType = sortSelect.value;
      const sorted = [...plantsList];
      if (sortType === 'created') return sorted;
      if (sortType === 'id') return sorted.sort((a, b) => a.id.localeCompare(b.id));
      if (sortType === 'alert') {
        return sorted.sort((a, b) => {
          const aDanger = isAlertNeeded(a);
          const bDanger = isAlertNeeded(b);
          if (aDanger && !bDanger) return -1;
          if (!aDanger && bDanger) return 1;
          const aLog = a.logs.find(l => l.type === 'æ°´');
          const bLog = b.logs.find(l => l.type === 'æ°´');
          return (aLog ? aLog.ts : 0) - (bLog ? bLog.ts : 0);
        });
      }
      if (sortType === 'dry_slow') {
        return sorted.sort((a, b) => (calculateAverageInterval(b) || -1) - (calculateAverageInterval(a) || -1));
      }
      if (sortType === 'dry_fast') {
        return sorted.sort((a, b) => (calculateAverageInterval(a) || 9999) - (calculateAverageInterval(b) || 9999));
      }
      return sorted;
    };
    const filterPlants = (plantsList) => {
      if (!searchQuery) return plantsList;
      return plantsList.filter(p => p.id.toLowerCase().includes(searchQuery.toLowerCase()));
    };

    // ========================================
    // æç”» (render) - Dark Mode
    // ========================================
    window.toggleAccordion = (id) => {
      const content = document.getElementById(`accordion-${id}`);
      const arrow = document.getElementById(`arrow-${id}`);
      content.classList.toggle('expanded');
      arrow.classList.toggle('rotated');
    };

    const render = () => {
      const filteredPlants = filterPlants(plants);
      const sortedPlants = sortPlants(filteredPlants);
      const currentSort = sortSelect.value;
      plantListEl.innerHTML = '';

      if (sortedPlants.length === 0) {
        emptyState.classList.remove('hidden');
      } else {
        emptyState.classList.add('hidden');
      }

      sortedPlants.forEach(plant => {
        const isDanger = isAlertNeeded(plant);
        
        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«
        const baseClass = "rounded-xl overflow-hidden relative transition-all duration-300 border shadow-lg";
        const cardClass = isDanger 
          ? `${baseClass} bg-red-900/10 border-red-500/50` 
          : `${baseClass} bg-gray-800 border-gray-700 hover:border-gray-600`;

        const sortedLogs = plant.logs ? [...plant.logs].sort((a, b) => b.ts - a.ts) : [];
        const recentLogs = sortedLogs.slice(0, 5);
        const lastLog = sortedLogs[0];
        
        const headerInfoHtml = lastLog 
          ? formatLogDisplay(lastLog)
          : '<span class="text-gray-600 text-xs">No Record</span>';
        
        const avgInterval = calculateAverageInterval(plant);
        const avgText = (avgInterval !== null) ? `<span class="text-teal-400 font-bold">${avgInterval}æ—¥</span>` : '<span class="text-gray-600">---</span>';

        // ãƒãƒƒã‚¸
        let badgeHtml = '';
        if (currentSort === 'dry_slow' && avgInterval !== null) {
          badgeHtml = `<span class="absolute top-4 right-12 bg-gray-700 text-gray-300 text-[10px] font-bold px-2 py-1 rounded border border-gray-600">AVG ${avgInterval}d</span>`;
        } else if (currentSort === 'dry_fast' && avgInterval !== null) {
          badgeHtml = `<span class="absolute top-4 right-12 bg-orange-900/50 text-orange-200 text-[10px] font-bold px-2 py-1 rounded border border-orange-700/50">AVG ${avgInterval}d</span>`;
        }

        // å±¥æ­´ãƒªã‚¹ãƒˆ
        let historyListHtml = '';
        if (recentLogs.length > 0) {
          historyListHtml = recentLogs.map(log => {
            let icon = 'ğŸ“'; let colorClass = 'text-gray-400 bg-gray-700 border-gray-600';
            if (log.type === 'æ°´') { icon = 'ğŸ’§'; colorClass = 'text-blue-300 bg-blue-900/30 border-blue-800/50'; }
            else if (log.type === 'æ¶²è‚¥') { icon = 'ğŸ’Š'; colorClass = 'text-green-300 bg-green-900/30 border-green-800/50'; }
            else if (log.type === 'æ´»åŠ›å‰¤') { icon = 'âš¡'; colorClass = 'text-yellow-300 bg-yellow-900/30 border-yellow-800/50'; }

            return `
              <div class="flex justify-between items-center py-2 border-b border-gray-700 last:border-0 text-sm">
                <span class="text-gray-500 font-mono text-xs">${formatDate(log.ts)}</span>
                <span class="flex-1 text-right">
                  <span class="text-xs px-2 py-1 rounded border ${colorClass}">
                    ${icon} ${log.type}
                  </span>
                </span>
              </div>
            `;
          }).join('');
        } else {
          historyListHtml = `<div class="p-3 text-center text-gray-600 text-xs italic">No History</div>`;
        }

        const card = document.createElement('div');
        card.className = cardClass;
        card.dataset.plantId = plant.id;
        
        card.innerHTML = `
          ${badgeHtml}
          <div class="accordion-header p-4 flex items-center justify-between cursor-pointer hover:bg-white/5 transition" onclick="toggleAccordion('${plant.id}')">
            <div class="flex items-center gap-4">
              <div class="flex-shrink-0 text-2xl filter drop-shadow-lg">
                ${isDanger ? 'âš ï¸' : 'ğŸŒ¿'}
              </div>
              <div class="flex flex-col">
                <span class="font-bold text-gray-100 text-lg tracking-wide">${plant.id}</span>
                <div class="text-xs text-gray-500 mt-1 flex items-center">
                  <span class="mr-2">Last:</span> ${headerInfoHtml}
                </div>
              </div>
            </div>
            <div id="arrow-${plant.id}" class="arrow-icon text-gray-600 text-xl transform transition-transform duration-300">â–¼</div>
          </div>

          <div id="accordion-${plant.id}" class="accordion-content bg-gray-900/50 shadow-inner max-h-0 overflow-hidden transition-all duration-300">
            <div class="p-4 border-t border-gray-700">
              
              <div onclick="event.stopPropagation(); openImageUpload('${plant.id}')" class="w-full h-48 mb-4 cursor-pointer hover:opacity-80 transition rounded-lg overflow-hidden border border-gray-700 bg-gray-800 relative group">
                ${plant.image 
                  ? `<img src="${plant.image}" class="w-full h-full object-cover" alt="${plant.id}">`
                  : `<div class="w-full h-full flex flex-col items-center justify-center text-gray-600 text-sm">
                       <span class="text-3xl mb-2 opacity-30">ğŸ“·</span>
                       <span>No Photo</span>
                     </div>`
                }
                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                  <span class="text-xs font-bold text-white border border-white/30 px-3 py-1 rounded-full backdrop-blur-sm">Change</span>
                </div>
              </div>

              <div class="mb-3 px-1 flex justify-between items-end border-b border-gray-700 pb-2">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">History</span>
                <span class="text-xs text-gray-400">Avg Pace: ${avgText}</span>
              </div>

              <div class="bg-gray-800/50 rounded-lg px-2 py-1 mb-5">
                ${historyListHtml}
              </div>

              <div class="grid grid-cols-3 gap-3 mb-4">
                <button onclick="event.stopPropagation(); addLog('${plant.id}', 'æ¶²è‚¥')" class="bg-gray-800 hover:bg-gray-700 text-green-400 border border-green-900 font-bold py-3 text-sm rounded-lg shadow-lg active:scale-95 transition flex flex-col items-center gap-1 group">
                  <span class="group-hover:scale-110 transition">ğŸ’Š</span><span class="text-xs">æ¶²è‚¥</span>
                </button>
                <button onclick="event.stopPropagation(); addLog('${plant.id}', 'æ°´')" class="bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 text-sm rounded-lg shadow-lg shadow-teal-900/50 active:scale-95 transition flex flex-col items-center gap-1 transform scale-105 border border-teal-500">
                  <span>ğŸ’§</span><span>æ°´ã‚„ã‚Š</span>
                </button>
                <button onclick="event.stopPropagation(); addLog('${plant.id}', 'æ´»åŠ›å‰¤')" class="bg-gray-800 hover:bg-gray-700 text-yellow-400 border border-yellow-900 font-bold py-3 text-sm rounded-lg shadow-lg active:scale-95 transition flex flex-col items-center gap-1 group">
                  <span class="group-hover:scale-110 transition">âš¡</span><span class="text-xs">æ´»åŠ›å‰¤</span>
                </button>
              </div>

              <div class="text-right">
                <button onclick="event.stopPropagation(); deletePlant('${plant.id}')" class="text-gray-600 hover:text-red-400 text-xs underline transition">
                  ğŸ—‘ï¸ Delete
                </button>
              </div>

            </div>
          </div>
        `;
        plantListEl.appendChild(card);
      });
    };

    searchInput.addEventListener('input', (e) => {
      searchQuery = e.target.value;
      render();
    });
    sortSelect.addEventListener('change', render);

    render();
  </script>
</body>
</html>