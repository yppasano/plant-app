<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ¤ç‰©ã‚µã‚¤ã‚¯ãƒ«ç®¡ç† + OCRã‚¹ã‚­ãƒ£ãƒŠãƒ¼</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .guide-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 150px;
      border: 3px dashed #14b8a6;
      border-radius: 8px;
      pointer-events: none;
      background: rgba(20, 184, 166, 0.1);
    }
    .guide-text {
      position: absolute;
      top: -35px;
      left: 50%;
      transform: translateX(-50%);
      background: #14b8a6;
      color: white;
      padding: 6px 12px;
      border-radius: 6px;
      font-weight: bold;
      font-size: 12px;
      white-space: nowrap;
    }
    video, canvas {
      max-width: 100%;
      border-radius: 8px;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 p-4 max-w-md mx-auto">

  <!-- ========== ã‚«ãƒ¡ãƒ©OCRã‚»ã‚¯ã‚·ãƒ§ãƒ³ ========== -->
  <div class="mb-6">
    <header class="mb-4 text-center">
      <h1 class="text-2xl font-bold text-teal-700">ğŸŒ¿ æ¤ç‰©ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†</h1>
      <p class="text-sm text-gray-600 mt-1">ã‚«ãƒ¡ãƒ©ã§æ’®å½± â†’ AIè§£æ â†’ è‡ªå‹•è¿½åŠ </p>
    </header>

    <!-- ã‚«ãƒ¡ãƒ©ãƒ“ãƒ¥ãƒ¼ -->
    <div class="relative inline-block w-full mb-3">
      <video id="video" autoplay playsinline class="w-full border-2 border-teal-300"></video>
      <div class="guide-frame">
        <div class="guide-text">ã‚¿ã‚°ã‚’ã“ã“ã«åã‚ã¦æ’®å½±</div>
      </div>
    </div>
    <canvas id="canvas" class="hidden w-full border-2 border-teal-300"></canvas>

    <!-- æ’®å½±ãƒœã‚¿ãƒ³ -->
    <div class="flex gap-2 mb-3">
      <button id="snapBtn" class="flex-1 bg-teal-600 text-white font-bold py-3 rounded-lg shadow hover:bg-teal-700 active:scale-95 transition">
        ğŸ“¸ æ’®å½±ã—ã¦è§£æ
      </button>
      <button id="retryBtn" class="hidden flex-1 bg-green-500 text-white font-bold py-3 rounded-lg shadow hover:bg-green-600 active:scale-95 transition">
        ğŸ”„ ã‚‚ã†ä¸€åº¦
      </button>
    </div>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
    <div id="status" class="text-center py-2 px-3 rounded-lg text-sm font-bold bg-gray-200 text-gray-700">
      ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
    <details class="mt-3">
      <summary class="cursor-pointer text-xs text-gray-500">ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±</summary>
      <div id="debug" class="mt-2 bg-gray-100 p-2 rounded text-xs whitespace-pre-wrap text-left"></div>
    </details>
  </div>

  <!-- ========== æ¤ç‰©ãƒªã‚¹ãƒˆç®¡ç†ã‚»ã‚¯ã‚·ãƒ§ãƒ³ ========== -->
  <div class="border-t-2 border-gray-300 pt-4">
    <!-- ä¸¦ã³æ›¿ãˆ -->
    <div class="flex justify-end mb-2">
      <select id="sortSelect" class="bg-white border border-gray-300 text-gray-700 text-xs rounded-lg p-2">
        <option value="created">â–¼ ç™»éŒ²é † (æ–°ã—ã„é †)</option>
        <option value="id">A-Z IDé †</option>
        <option value="alert">ğŸ’§ æ°´ã‚„ã‚Šå¾…ã¡é †</option>
      </select>
    </div>

    <!-- æ‰‹å‹•è¿½åŠ ãƒ•ã‚©ãƒ¼ãƒ  -->
    <div class="flex gap-2 mb-4">
      <input type="text" id="manualIdInput" placeholder="æ‰‹å‹•è¿½åŠ  (ä¾‹: B-02)" 
        class="flex-1 p-2 border border-gray-300 rounded shadow-sm text-sm focus:outline-none focus:border-teal-500" />
      <button id="addBtn" class="bg-teal-600 text-white px-4 py-2 rounded shadow hover:bg-teal-700 font-bold text-sm">
        è¿½åŠ 
      </button>
    </div>

    <!-- æ¤ç‰©ãƒªã‚¹ãƒˆ -->
    <div id="plantList" class="space-y-3"></div>
  </div>

  <!-- éš ã—ã‚«ãƒ¡ãƒ©å…¥åŠ›ï¼ˆå†™çœŸè¿½åŠ ç”¨ï¼‰ -->
  <input type="file" id="cameraInput" accept="image/*" capture="environment" class="hidden" />

  <script>
    // ========================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒ»å®šæ•°
    // ========================================
    const STORAGE_KEY = 'plantCycleData';
    const ALERT_DAYS = 7;
    let plants = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let targetPlantId = null;

    // DOMè¦ç´ ï¼ˆã‚«ãƒ¡ãƒ©OCRï¼‰
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const snapBtn = document.getElementById('snapBtn');
    const retryBtn = document.getElementById('retryBtn');
    const statusDiv = document.getElementById('status');
    const debugDiv = document.getElementById('debug');

    // DOMè¦ç´ ï¼ˆæ¤ç‰©ç®¡ç†ï¼‰
    const manualIdInput = document.getElementById('manualIdInput');
    const addBtn = document.getElementById('addBtn');
    const sortSelect = document.getElementById('sortSelect');
    const plantListEl = document.getElementById('plantList');
    const cameraInput = document.getElementById('cameraInput');

    // ========================================
    // ä¿å­˜ãƒ»æç”»
    // ========================================
    const save = () => {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(plants));
        render();
      } catch (e) {
        alert('ãƒ‡ãƒ¼ã‚¿å®¹é‡ãŒã„ã£ã±ã„ã§ã™ã€‚å¤ã„å†™çœŸã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚');
      }
    };

    // ========================================
    // æ¤ç‰©ã®è¿½åŠ ã¾ãŸã¯é¸æŠï¼ˆé‡è¦ï¼šçµ±åˆãƒã‚¤ãƒ³ãƒˆï¼‰
    // ========================================
    const addOrSelectPlant = (id) => {
      if (!id || !id.trim()) return;
      id = id.trim();
      
      const existing = plants.find(p => p.id === id);
      if (existing) {
        // æ—¢å­˜ã®å ´åˆï¼šç”»é¢ã‚’ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ãƒã‚¤ãƒ©ã‚¤ãƒˆ
        save(); // å†æç”»
        setTimeout(() => {
          const card = Array.from(plantListEl.children).find(el => el.dataset.plantId === id);
          if (card) {
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            card.classList.add('ring-4', 'ring-teal-500');
            setTimeout(() => card.classList.remove('ring-4', 'ring-teal-500'), 2000);
          }
        }, 100);
      } else {
        // æ–°è¦ã®å ´åˆï¼šå…ˆé ­ã«è¿½åŠ 
        plants.unshift({ id, logs: [], image: null });
        save();
      }
    };

    // ========================================
    // ã‚«ãƒ¡ãƒ©OCRãƒ­ã‚¸ãƒƒã‚¯
    // ========================================
    navigator.mediaDevices.getUserMedia({ 
      video: { 
        facingMode: "environment",
        width: { ideal: 1920 },
        height: { ideal: 1080 }
      } 
    })
    .then(stream => {
      video.srcObject = stream;
      statusDiv.textContent = "âœ… æº–å‚™å®Œäº†ï¼ã‚¿ã‚°ã‚’æ’®å½±ã—ã¦ãã ã•ã„";
      statusDiv.className = "text-center py-2 px-3 rounded-lg text-sm font-bold bg-green-100 text-green-700";
    })
    .catch(err => {
      console.error("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:", err);
      statusDiv.textContent = "âŒ ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“";
      statusDiv.className = "text-center py-2 px-3 rounded-lg text-sm font-bold bg-red-100 text-red-700";
    });

    snapBtn.addEventListener('click', async () => {
      video.classList.add('hidden');
      canvas.classList.remove('hidden');
      snapBtn.disabled = true;
      retryBtn.classList.remove('hidden');
      
      const context = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      statusDiv.textContent = "â³ AIã§è§£æä¸­...";
      statusDiv.className = "text-center py-2 px-3 rounded-lg text-sm font-bold bg-yellow-100 text-yellow-700";

      try {
        const imageBase64 = canvas.toDataURL('image/jpeg', 0.95);
        debugDiv.textContent = "ğŸ“¤ ç”»åƒã‚’é€ä¿¡ä¸­...\nç”»åƒã‚µã‚¤ã‚º: " + Math.round(imageBase64.length / 1024) + " KB";
        
        const response = await fetch('/api/scan-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageBase64 })
        });

        const result = await response.json();
        debugDiv.textContent = "ğŸ“¥ Geminiã‹ã‚‰ã®è¿”ç­”:\n" + JSON.stringify(result, null, 2);
        
        if (result.id && result.id !== "NOT_FOUND") {
          statusDiv.textContent = `âœ… è§£æå®Œäº†ï¼ ID: ${result.id}`;
          statusDiv.className = "text-center py-2 px-3 rounded-lg text-sm font-bold bg-green-100 text-green-700";
          
          // ã€é‡è¦ã€‘AIè§£ææˆåŠŸæ™‚ã«è‡ªå‹•çš„ã«æ¤ç‰©ã‚’è¿½åŠ ã¾ãŸã¯é¸æŠ
          addOrSelectPlant(result.id);
        } else {
          statusDiv.textContent = "âš ï¸ IDã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚ã‚‚ã†ä¸€åº¦æ’®å½±ã—ã¦ãã ã•ã„";
          statusDiv.className = "text-center py-2 px-3 rounded-lg text-sm font-bold bg-red-100 text-red-700";
        }
      } catch (error) {
        console.error("è§£æã‚¨ãƒ©ãƒ¼:", error);
        debugDiv.textContent = "âŒ ã‚¨ãƒ©ãƒ¼è©³ç´°:\n" + error.toString();
        statusDiv.textContent = "âŒ è§£æã«å¤±æ•—ã—ã¾ã—ãŸ";
        statusDiv.className = "text-center py-2 px-3 rounded-lg text-sm font-bold bg-red-100 text-red-700";
      }
      
      snapBtn.disabled = false;
    });

    retryBtn.addEventListener('click', () => {
      canvas.classList.add('hidden');
      video.classList.remove('hidden');
      retryBtn.classList.add('hidden');
      statusDiv.textContent = "âœ… æº–å‚™å®Œäº†ï¼ã‚¿ã‚°ã‚’æ’®å½±ã—ã¦ãã ã•ã„";
      statusDiv.className = "text-center py-2 px-3 rounded-lg text-sm font-bold bg-green-100 text-green-700";
    });

    // ========================================
    // æ¤ç‰©ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯
    // ========================================
    window.addLog = (id, type) => {
      const plant = plants.find(p => p.id === id);
      if (!plant) return;
      const today = new Date();
      const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
      const timestamp = today.getTime();
      plant.logs.unshift({ type, date: dateStr, ts: timestamp });
      if (plant.logs.length > 50) plant.logs.pop();
      save();
    };

    window.deletePlant = (id) => {
      if (!confirm(`ID: ${id} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      plants = plants.filter(p => p.id !== id);
      save();
    };

    window.openCamera = (id) => {
      targetPlantId = id;
      cameraInput.click();
    };

    const compressImage = (file) => {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const MAX_WIDTH = 600;
            const scale = MAX_WIDTH / img.width;
            const width = scale < 1 ? MAX_WIDTH : img.width;
            const height = scale < 1 ? img.height * scale : img.height;
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', 0.7));
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      });
    };

    cameraInput.addEventListener('change', async (e) => {
      if (!e.target.files || !e.target.files[0] || !targetPlantId) return;
      const file = e.target.files[0];
      const imageBase64 = await compressImage(file);
      const plant = plants.find(p => p.id === targetPlantId);
      if (plant) {
        plant.image = imageBase64;
        save();
      }
      e.target.value = '';
    });

    const calculateDaysAgo = (log) => {
      if (!log) return null;
      if (log.ts) {
        const diff = Date.now() - log.ts;
        return Math.floor(diff / (1000 * 60 * 60 * 24));
      }
      try {
        const now = new Date();
        const [m, d] = log.date.split('/').map(Number);
        const logDate = new Date(now.getFullYear(), m - 1, d);
        if (logDate > now) logDate.setFullYear(now.getFullYear() - 1);
        const diff = now - logDate;
        return Math.floor(diff / (1000 * 60 * 60 * 24));
      } catch (e) {
        return null;
      }
    };

    const getDaysAgoHtml = (log) => {
      const days = calculateDaysAgo(log);
      if (days === null) return '';
      if (days === 0) return '<span class="text-teal-600 font-bold ml-1">(ä»Šæ—¥)</span>';
      return `<span class="text-gray-500 font-bold ml-1">(${days}æ—¥å‰)</span>`;
    };

    const isAlertNeeded = (plant) => {
      const lastWaterLog = plant.logs.find(l => l.type === 'æ°´');
      if (!lastWaterLog) return false;
      const days = calculateDaysAgo(lastWaterLog);
      return days !== null && days >= ALERT_DAYS;
    };

    const sortPlants = (plantsList) => {
      const sortType = sortSelect.value;
      const sorted = [...plantsList];

      if (sortType === 'created') {
        return sorted;
      } else if (sortType === 'id') {
        return sorted.sort((a, b) => a.id.localeCompare(b.id));
      } else if (sortType === 'alert') {
        return sorted.sort((a, b) => {
          const aDanger = isAlertNeeded(a);
          const bDanger = isAlertNeeded(b);
          if (aDanger && !bDanger) return -1;
          if (!aDanger && bDanger) return 1;
          const aLog = a.logs.find(l => l.type === 'æ°´');
          const bLog = b.logs.find(l => l.type === 'æ°´');
          const aTime = aLog ? (aLog.ts || 0) : 0;
          const bTime = bLog ? (bLog.ts || 0) : 0;
          return aTime - bTime;
        });
      }
      return sorted;
    };

    const render = () => {
      plantListEl.innerHTML = '';
      const sortedPlants = sortPlants(plants);

      sortedPlants.forEach(plant => {
        const isDanger = isAlertNeeded(plant);
        const cardClass = isDanger 
          ? 'bg-red-50 p-3 rounded-xl shadow border-2 border-red-400 relative overflow-hidden'
          : 'bg-white p-3 rounded-xl shadow border border-gray-100';

        const alertBadge = isDanger
          ? `<div class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-bl-lg">æ°´ã‚„ã‚Šæ³¨æ„ï¼</div>`
          : '';

        let log1Html = 'ãƒ¼';
        let log2Html = 'ãƒ¼';
        if (plant.logs[0]) log1Html = `${plant.logs[0].type} (${plant.logs[0].date}) ${getDaysAgoHtml(plant.logs[0])}`;
        if (plant.logs[1]) log2Html = `${plant.logs[1].type} (${plant.logs[1].date}) ${getDaysAgoHtml(plant.logs[1])}`;

        const imageHtml = plant.image 
          ? `<img src="${plant.image}" class="w-full h-32 object-cover rounded-lg mb-2 cursor-pointer hover:opacity-90 shadow-sm" onclick="openCamera('${plant.id}')">`
          : `<div onclick="openCamera('${plant.id}')" class="w-full h-20 bg-gray-100 rounded-lg mb-2 flex items-center justify-center text-gray-400 cursor-pointer hover:bg-gray-200 border-2 border-dashed border-gray-300">
               <span class="text-xs">ğŸ“· å†™çœŸã‚’è¿½åŠ </span>
             </div>`;

        const card = document.createElement('div');
        card.className = cardClass;
        card.dataset.plantId = plant.id;
        
        card.innerHTML = `
          ${alertBadge}
          <div class="flex justify-between items-center mb-2">
            <h2 class="text-lg font-bold text-gray-700">${plant.id}</h2>
            <button onclick="deletePlant('${plant.id}')" class="text-xs text-red-400 hover:text-red-600">å‰Šé™¤</button>
          </div>
          
          ${imageHtml}
          
          <div class="bg-white/50 p-2 rounded-lg mb-3 text-xs">
            <div class="flex justify-between mb-1 items-center">
              <span class="font-bold text-gray-500">å‰å›</span> 
              <span class="flex-1 text-right">${log1Html}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="font-bold text-gray-400">å‰ã€…å›</span> 
              <span class="flex-1 text-right text-gray-400">${log2Html}</span>
            </div>
          </div>

          <div class="grid grid-cols-3 gap-2">
            <button onclick="addLog('${plant.id}', 'æ¶²è‚¥')" class="bg-orange-400 hover:bg-orange-500 text-white font-bold py-2 text-sm rounded-lg shadow-sm active:scale-95 transition">æ¶²è‚¥</button>
            <button onclick="addLog('${plant.id}', 'æ°´')" class="bg-blue-400 hover:bg-blue-500 text-white font-bold py-2 text-sm rounded-lg shadow-sm active:scale-95 transition">æ°´</button>
            <button onclick="addLog('${plant.id}', 'æ´»åŠ›å‰¤')" class="bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-2 text-sm rounded-lg shadow-sm active:scale-95 transition">æ´»åŠ›å‰¤</button>
          </div>
        `;
        plantListEl.appendChild(card);
      });
    };

    sortSelect.addEventListener('change', () => {
      render();
    });

    addBtn.addEventListener('click', () => {
      const id = manualIdInput.value.trim();
      if (!id) {
        alert('æ¤ç‰©IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼');
        return;
      }
      if (plants.some(p => p.id === id)) {
        alert('ãã®IDã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™');
        return;
      }
      plants.unshift({ id, logs: [], image: null });
      manualIdInput.value = '';
      save();
    });

    // åˆæœŸæç”»
    render();
  </script>

</body>
</html>
