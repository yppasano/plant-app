<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="robots" content="noindex, nofollow" />
  <title>Cycle Monitor</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .guide-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 200px;
      border: 3px dashed #14b8a6;
      border-radius: 12px;
      pointer-events: none;
      background: rgba(20, 184, 166, 0.1);
    }
    .guide-text {
      position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      background: #14b8a6;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
      white-space: nowrap;
    }
    .fab {
      position: fixed;
      right: 20px;
      bottom: 80px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
      z-index: 40;
      transition: transform 0.2s;
    }
    .fab:active {
      transform: scale(0.9);
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: black;
      z-index: 50;
      display: flex;
      flex-direction: column;
    }
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 50;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .action-sheet {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      border-radius: 20px 20px 0 0;
      z-index: 50;
      animation: slideUp 0.3s ease-out;
      box-shadow: 0 -4px 16px rgba(0,0,0,0.2);
    }
    @keyframes slideUp {
      from { transform: translateY(100%); }
      to { transform: translateY(0); }
    }
    .highlight-card {
      animation: highlight 1.5s ease-in-out;
    }
    @keyframes highlight {
      0%, 100% { background-color: white; }
      50% { background-color: #a7f3d0; }
    }
    .accordion-header {
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .accordion-header:hover {
      background-color: rgba(0, 0, 0, 0.02);
    }
    .accordion-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-out;
    }
    .accordion-content.expanded {
      max-height: 500px;
      transition: max-height 0.3s ease-in;
    }
    .arrow-icon {
      transition: transform 0.3s ease;
    }
    .arrow-icon.rotated {
      transform: rotate(180deg);
    }
/* === è¿½åŠ : è©³ç´°ãƒªã‚¹ãƒˆã®ãƒ‡ã‚¶ã‚¤ãƒ³ === */
.stats-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #f3f4f6;
      font-size: 0.95rem;
      color: #4b5563;
    }
    .stats-row:last-child {
      border-bottom: none;
    }
    .stats-label {
      font-size: 0.85rem;
      color: #9ca3af;
    }
    .stats-value {
      font-weight: 600;
      color: #374151;
    }
    
    /* === è¿½åŠ : æ§ãˆã‚ãªå‰Šé™¤ãƒœã‚¿ãƒ³ === */
    .delete-link {
      display: inline-block;
      margin-top: 15px;
      font-size: 0.8rem;
      color: #9ca3af; /* è–„ã„ã‚°ãƒ¬ãƒ¼ */
      text-decoration: underline;
      background: none;
      border: none;
      cursor: pointer;
      padding: 5px;
    }
    .delete-link:hover {
      color: #ef4444; /* ãƒ›ãƒãƒ¼æ™‚ã ã‘èµ¤ã */
    }
  </style>
</head>
<body class="bg-gray-900 text-gray-100 pb-20 antialiased selection:bg-teal-500 selection:text-white">

  <div id="mainScreen" class="max-w-md mx-auto min-h-screen bg-gray-900 relative">
    
    <header class="bg-gray-900/90 backdrop-blur-md border-b border-gray-800 p-4 sticky top-0 z-30 flex justify-between items-center">
      <h1 class="text-xl font-bold tracking-wider flex items-center gap-2">
        <span class="text-2xl">ğŸŒ¿</span>
        <span class="bg-clip-text text-transparent bg-gradient-to-r from-teal-400 to-emerald-400">Cycle Monitor</span>
      </h1>
      <button id="settingsBtn" class="text-2xl text-gray-400 hover:text-teal-400 transition p-2 rounded-full hover:bg-gray-800">âš™ï¸</button>
    </header>

    <div class="p-4 bg-gray-900">
      <div class="relative">
        <span class="absolute left-3 top-3 text-gray-500">ğŸ”</span>
        <input 
          type="text" 
          id="searchInput" 
          placeholder="ID search..." 
          class="w-full pl-10 p-3 bg-gray-800 border border-gray-700 rounded-xl text-gray-200 placeholder-gray-600 focus:outline-none focus:border-teal-500 focus:ring-1 focus:ring-teal-500 transition"
        />
      </div>
    </div>

    <div class="px-4 pb-2 flex justify-between items-center">
      <span class="text-xs text-gray-500 font-bold uppercase tracking-wider">Sort By</span>
      <div class="relative">
        <select id="sortSelect" class="appearance-none bg-gray-800 border border-gray-700 text-teal-400 text-xs font-bold rounded-lg py-2 pl-3 pr-8 focus:border-teal-500 outline-none cursor-pointer hover:bg-gray-750 transition">
          <option value="created">â–¼ Newest</option>
          <option value="id">ğŸ”¤ ID (A-Z)</option>
          <option value="alert">âš ï¸ Alert Priority</option>
          <option value="dry_slow">ğŸ¢ Slow Dry</option>
          <option value="dry_fast">ğŸ‡ Fast Dry</option>
        </select>
        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-500">
          <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z"/></svg>
        </div>
      </div>
    </div>

    <div id="plantList" class="p-4 space-y-4"></div>

    <!-- ãƒªã‚¹ãƒˆãŒç©ºã®å ´åˆ -->
    <div id="emptyState" class="hidden text-center py-12 text-gray-400">
      <p class="text-lg mb-2">ğŸ“ ç™»éŒ²ã•ã‚ŒãŸæ¤ç‰©ãŒã‚ã‚Šã¾ã›ã‚“</p>
      <p class="text-sm">å³ä¸‹ã® ï¼‹ ãƒœã‚¿ãƒ³ã§æ¤ç‰©ã‚’è¿½åŠ ã§ãã¾ã™</p>
    </div>
  </div>

  <!-- ========== Floating Action Button ========== -->
  <button id="fabBtn" class="fab bg-teal-600 hover:bg-teal-700 text-white">
    ï¼‹
  </button>

  <!-- ========== ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒˆï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰ ========== -->
  <div id="actionSheetOverlay" class="hidden fixed inset-0 bg-black/30 z-40" onclick="closeActionSheet()"></div>
  <div id="actionSheet" class="hidden action-sheet">
    <div class="p-6 space-y-3">
      <h3 class="text-lg font-bold text-gray-800 mb-4">è¿½åŠ æ–¹æ³•ã‚’é¸æŠ</h3>
      <button id="cameraOptionBtn" class="w-full bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 rounded-lg text-lg flex items-center justify-center gap-2">
        ğŸ“· ã‚«ãƒ¡ãƒ©ã§è¿½åŠ 
      </button>
      <button id="manualOptionBtn" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 rounded-lg text-lg flex items-center justify-center gap-2">
        âŒ¨ï¸ æ‰‹å‹•ã§IDå…¥åŠ›
      </button>
      <button onclick="closeActionSheet()" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg">
        ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      </button>
    </div>
  </div>

  <!-- ========== æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ« ========== -->
  <div id="manualInputModal" class="hidden modal-overlay" onclick="closeManualModal(event)">
    <div class="bg-white rounded-xl p-6 max-w-sm w-full" onclick="event.stopPropagation()">
      <h3 class="text-xl font-bold text-gray-800 mb-4">æ¤ç‰©IDã‚’å…¥åŠ›</h3>
      <input 
        type="text" 
        id="manualIdInput" 
        placeholder="ä¾‹: A-01" 
        class="w-full p-3 border border-gray-300 rounded-lg mb-4 text-lg focus:outline-none focus:border-teal-500"
      />
      <div class="flex gap-3">
        <button onclick="closeManualModal()" class="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 font-bold py-3 rounded-lg">
          ã‚­ãƒ£ãƒ³ã‚»ãƒ«
        </button>
        <button id="manualSubmitBtn" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 rounded-lg">
          ç™»éŒ²
        </button>
      </div>
    </div>
  </div>

  <!-- ========== ãƒ‡ãƒ¼ã‚¿ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« ========== -->
  <div id="dataManagementModal" class="hidden modal-overlay" onclick="closeDataManagementModal(event)">
    <div class="bg-white rounded-xl p-6 max-w-sm w-full" onclick="event.stopPropagation()">
      <h3 class="text-xl font-bold text-gray-800 mb-4">âš™ï¸ ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
      
      <div class="space-y-3">
        <!-- ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜ -->
        <button id="exportBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2">
          ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜
        </button>

        <!-- ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ -->
        <button id="importBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2">
          ğŸ“¤ ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
        </button>

        <!-- å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ -->
        <button id="clearAllBtn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-3 rounded-lg flex items-center justify-center gap-2">
          ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
        </button>

        <div class="pt-3 border-t">
          <p class="text-xs text-gray-500 mb-2">ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿æ•°: <span id="dataCount" class="font-bold">0</span>ä»¶</p>
        </div>
      </div>

      <button onclick="closeDataManagementModal()" class="w-full mt-4 bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-3 rounded-lg">
        é–‰ã˜ã‚‹
      </button>
    </div>
  </div>

  <!-- ========== ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ ========== -->
  <div id="scanOverlay" class="fixed inset-0 bg-black z-50 hidden">
    
    <div class="absolute inset-0 z-0">
      <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
      <canvas id="canvas" class="hidden"></canvas>
      
      <div class="guide-frame">
        <div class="guide-text">ã‚¿ã‚°ã‚’ã“ã“ã«åã‚ã¦æ’®å½±</div>
      </div>
    </div>

    <div class="absolute bottom-0 left-0 right-0 z-10 flex flex-col px-4 pb-6 pt-12 bg-gradient-to-t from-black via-black/90 to-transparent">
      
      <div id="scanStatus" class="mb-4 bg-black/60 backdrop-blur-md text-white text-center py-2 px-4 rounded-full text-sm font-bold border border-white/20 shadow-lg mx-auto">
        ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...
      </div>

      <div class="flex gap-3 mb-2">
        <button id="closeScanBtn" class="flex-1 bg-gray-600/90 hover:bg-gray-700 text-white font-bold py-4 rounded-xl text-lg shadow-lg backdrop-blur-sm border border-white/10 active:scale-95 transition">
          âœ• é–‰ã˜ã‚‹
        </button>
        <button id="captureBtn" class="flex-1 bg-teal-600/90 hover:bg-teal-700 text-white font-bold py-4 rounded-xl text-lg shadow-lg backdrop-blur-sm border border-white/10 active:scale-95 transition">
          ğŸ“¸ æ’®å½±
        </button>
      </div>

      <details class="mt-2">
        <summary class="cursor-pointer text-xs text-gray-400 text-center py-2 opacity-70">ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º</summary>
        <div id="debugInfo" class="mt-1 bg-gray-900/90 text-gray-200 p-3 rounded-lg text-xs whitespace-pre-wrap max-h-24 overflow-auto border border-gray-700 shadow-inner"></div>
      </details>
      
      <div class="h-[env(safe-area-inset-bottom)]"></div>
    </div>
  </div>

  <!-- ========== éš ã—ãƒ•ã‚¡ã‚¤ãƒ«å…¥åŠ› ========== -->
  <input type="file" id="imageFileInput" accept="image/*" class="hidden" />
  <input type="file" id="importFileInput" accept="application/json" class="hidden" />

  <script>
    // ========================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒ»å®šæ•°
    // ========================================
    const STORAGE_KEY = 'plantCycleData';
    const ALERT_DAYS = 7;
    let plants = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let cameraStream = null;
    let searchQuery = '';
    let currentImageTargetId = null;

// ========================================
    // ç°¡æ˜“ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆè‡ªåˆ†å°‚ç”¨ãƒ­ãƒƒã‚¯ï¼‰
    // ========================================
    const MY_PASSWORD = "1202"; // â˜…ã“ã“ã«å¥½ããªãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’è¨­å®š
    const LOCK_KEY = "app_unlocked";

    const checkLock = () => {
      const isUnlocked = sessionStorage.getItem(LOCK_KEY);
      if (isUnlocked !== "true") {
        const input = prompt("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:");
        if (input === MY_PASSWORD) {
          sessionStorage.setItem(LOCK_KEY, "true");
          alert("èªè¨¼æˆåŠŸï¼");
        } else {
          alert("ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ãŒé•ã„ã¾ã™ã€‚");
          document.body.innerHTML = '<div style="display:flex;justify-content:center;align-items:center;height:100vh;font-weight:bold;">â›” ACCESS DENIED</div>';
          throw new Error("Access Denied"); // å‡¦ç†ã‚’å¼·åˆ¶åœæ­¢
        }
      }
    };
    // èµ·å‹•æ™‚ã«ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
    checkLock();
    
    // DOMè¦ç´ 
    const fabBtn = document.getElementById('fabBtn');
    const actionSheetOverlay = document.getElementById('actionSheetOverlay');
    const actionSheet = document.getElementById('actionSheet');
    const cameraOptionBtn = document.getElementById('cameraOptionBtn');
    const manualOptionBtn = document.getElementById('manualOptionBtn');
    const manualInputModal = document.getElementById('manualInputModal');
    const manualIdInput = document.getElementById('manualIdInput');
    const manualSubmitBtn = document.getElementById('manualSubmitBtn');
    const scanOverlay = document.getElementById('scanOverlay');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const closeScanBtn = document.getElementById('closeScanBtn');
    const scanStatus = document.getElementById('scanStatus');
    const debugInfo = document.getElementById('debugInfo');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const plantListEl = document.getElementById('plantList');
    const emptyState = document.getElementById('emptyState');
    const imageFileInput = document.getElementById('imageFileInput');
    const settingsBtn = document.getElementById('settingsBtn');
    const dataManagementModal = document.getElementById('dataManagementModal');
    const dataCount = document.getElementById('dataCount');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const clearAllBtn = document.getElementById('clearAllBtn');
    const importFileInput = document.getElementById('importFileInput');

// ========================================
    // æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ (YYYY/MM/DD)
    // ========================================
    const formatDate = (ts) => {
      if (!ts) return '---';
      const d = new Date(ts);
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${year}/${month}/${day}`;
    };

    // ========================================
    // ä¿å­˜ãƒ»æç”»
    // ========================================
    const save = () => {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(plants));
        render();
      } catch (e) {
        alert('ãƒ‡ãƒ¼ã‚¿å®¹é‡ãŒã„ã£ã±ã„ã§ã™ã€‚å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚');
      }
    };

    // ========================================
    // ãƒ‡ãƒ¼ã‚¿ç®¡ç†æ©Ÿèƒ½
    // ========================================
    settingsBtn.addEventListener('click', () => {
      dataCount.textContent = plants.length;
      dataManagementModal.classList.remove('hidden');
    });

    window.closeDataManagementModal = (event) => {
      if (event && event.target !== dataManagementModal) return;
      dataManagementModal.classList.add('hidden');
    };

    // ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ä¿å­˜ï¼ˆã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆï¼‰
    exportBtn.addEventListener('click', () => {
      const dataStr = JSON.stringify(plants, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const today = new Date();
      const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
      a.href = url;
      a.download = `plants_backup_${dateStr}.json`;
      a.click();
      URL.revokeObjectURL(url);
      alert('âœ… ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
    });

    // ãƒ‡ãƒ¼ã‚¿å¾©å…ƒï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼‰
    importBtn.addEventListener('click', () => {
      importFileInput.click();
    });

    importFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (event) => {
        try {
          const importedData = JSON.parse(event.target.result);
          
          // ãƒ‡ãƒ¼ã‚¿å½¢å¼ãƒã‚§ãƒƒã‚¯
          if (!Array.isArray(importedData)) {
            alert('âŒ ç„¡åŠ¹ãªãƒ‡ãƒ¼ã‚¿å½¢å¼ã§ã™');
            return;
          }

          // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
          if (confirm(`ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ï¼ˆ${plants.length}ä»¶ï¼‰ã¯ã™ã¹ã¦ä¸Šæ›¸ãã•ã‚Œã¾ã™ãŒã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`)) {
            plants = importedData;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(plants));
            alert(`âœ… ${plants.length}ä»¶ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒã—ã¾ã—ãŸ`);
            location.reload();
          }
        } catch (error) {
          console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼:', error);
          alert('âŒ ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      };
      reader.readAsText(file);
      e.target.value = '';
    });

    // å…¨ãƒ‡ãƒ¼ã‚¿å‰Šé™¤
    clearAllBtn.addEventListener('click', () => {
      if (confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) {
        if (confirm('æœ€çµ‚ç¢ºèªï¼šã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒå‰Šé™¤ã•ã‚Œã¾ã™ã€‚æœ¬å½“ã«ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
          plants = [];
          localStorage.removeItem(STORAGE_KEY);
          alert('âœ… ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
          closeDataManagementModal();
          render();
        }
      }
    });

    // ========================================
    // ç”»åƒåœ§ç¸®ï¼ˆå…±é€šé–¢æ•°ï¼‰
    // ========================================
    const compressImage = (file, maxWidth = 300, quality = 0.5) => {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const scale = maxWidth / img.width;
            const width = scale < 1 ? maxWidth : img.width;
            const height = scale < 1 ? img.height * scale : img.height;
            
            canvas.width = width;
            canvas.height = height;
            ctx.drawImage(img, 0, 0, width, height);
            
            resolve(canvas.toDataURL('image/jpeg', quality));
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    };

    const resizeAndCompressCanvas = (sourceCanvas, maxWidth = 300, quality = 0.5) => {
      const tempCanvas = document.createElement('canvas');
      const ctx = tempCanvas.getContext('2d');
      
      const scale = maxWidth / sourceCanvas.width;
      const width = scale < 1 ? maxWidth : sourceCanvas.width;
      const height = scale < 1 ? sourceCanvas.height * scale : sourceCanvas.height;
      
      tempCanvas.width = width;
      tempCanvas.height = height;
      ctx.drawImage(sourceCanvas, 0, 0, width, height);
      
      return tempCanvas.toDataURL('image/jpeg', quality);
    };

    // ========================================
    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚·ãƒ¼ãƒˆï¼ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼‰
    // ========================================
    fabBtn.addEventListener('click', () => {
      actionSheetOverlay.classList.remove('hidden');
      actionSheet.classList.remove('hidden');
    });

    window.closeActionSheet = () => {
      actionSheetOverlay.classList.add('hidden');
      actionSheet.classList.add('hidden');
    };

    cameraOptionBtn.addEventListener('click', () => {
      closeActionSheet();
      openScanOverlay();
    });

    manualOptionBtn.addEventListener('click', () => {
      closeActionSheet();
      openManualModal();
    });

    // ========================================
    // æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ€ãƒ«
    // ========================================
    const openManualModal = () => {
      manualInputModal.classList.remove('hidden');
      manualIdInput.value = '';
      manualIdInput.focus();
    };

    window.closeManualModal = (event) => {
      if (event && event.target !== manualInputModal) return;
      manualInputModal.classList.add('hidden');
    };

    manualSubmitBtn.addEventListener('click', () => {
      const id = manualIdInput.value.trim();
      if (!id) {
        alert('æ¤ç‰©IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      const existing = plants.find(p => p.id === id);
      if (existing) {
        alert(`ID: ${id} ã¯æ—¢ã«ç™»éŒ²æ¸ˆã¿ã§ã™`);
        closeManualModal();
        render();
        setTimeout(() => {
          const card = document.querySelector(`[data-plant-id="${id}"]`);
          if (card) {
            card.scrollIntoView({ behavior: 'smooth', block: 'center' });
            card.classList.add('highlight-card');
            setTimeout(() => card.classList.remove('highlight-card'), 1500);
          }
        }, 300);
      } else {
        plants.unshift({ id, logs: [], image: null });
        save();
        closeManualModal();
      }
    });

    // ========================================
    // ã‚«ãƒ¡ãƒ©åˆ¶å¾¡
    // ========================================
    const startCamera = async () => {
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: "environment",
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          } 
        });
        video.srcObject = cameraStream;
        scanStatus.textContent = "âœ… ã‚¿ã‚°ã‚’æ’®å½±ã—ã¦ãã ã•ã„";
        scanStatus.className = "bg-green-600 text-white text-center py-3 px-4 text-sm font-bold";
      } catch (err) {
        console.error("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:", err);
        scanStatus.textContent = "âŒ ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ";
        scanStatus.className = "bg-red-600 text-white text-center py-3 px-4 text-sm font-bold";
      }
    };

    const stopCamera = () => {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
    };

    const openScanOverlay = () => {
      scanOverlay.classList.remove('hidden');
      startCamera();
    };

    closeScanBtn.addEventListener('click', () => {
      scanOverlay.classList.add('hidden');
      stopCamera();
      scanStatus.textContent = "ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...";
      scanStatus.className = "bg-black/80 text-white text-center py-3 px-4 text-sm font-bold";
    });

    // ========================================
    // æ’®å½±ãƒ»AIè§£æ
    // ========================================
    captureBtn.addEventListener('click', async () => {
      const context = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      scanStatus.textContent = "â³ AIã§è§£æä¸­...";
      scanStatus.className = "bg-yellow-600 text-white text-center py-3 px-4 text-sm font-bold";
      captureBtn.disabled = true;

      try {
        const imageBase64 = canvas.toDataURL('image/jpeg', 0.95);
        debugInfo.textContent = "ğŸ“¤ ç”»åƒã‚’é€ä¿¡ä¸­...\nç”»åƒã‚µã‚¤ã‚º: " + Math.round(imageBase64.length / 1024) + " KB";
        
        const response = await fetch('/api/scan-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageBase64 })
        });

        const result = await response.json();
        debugInfo.textContent = "ğŸ“¥ Geminiã‹ã‚‰ã®è¿”ç­”:\n" + JSON.stringify(result, null, 2);
        
        if (result.id && result.id !== "NOT_FOUND") {
          const detectedId = result.id;
          const existing = plants.find(p => p.id === detectedId);

          if (existing) {
            // ç™»éŒ²æ¸ˆã¿ï¼šç”»åƒã¯ä¿å­˜ã—ãªã„
            scanStatus.textContent = `âœ… ç™»éŒ²æ¸ˆã¿ã§ã™: ${detectedId}`;
            scanStatus.className = "bg-green-600 text-white text-center py-3 px-4 text-sm font-bold";
            
            setTimeout(() => {
              scanOverlay.classList.add('hidden');
              stopCamera();
              
              render();
              setTimeout(() => {
                const card = document.querySelector(`[data-plant-id="${detectedId}"]`);
                if (card) {
                  card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  card.classList.add('highlight-card');
                  setTimeout(() => card.classList.remove('highlight-card'), 1500);
                }
              }, 300);
            }, 1500);
            
          } else {
            // æ–°è¦ï¼šç”»åƒã‚’åœ§ç¸®ã—ã¦ä¿å­˜
            scanStatus.textContent = `ğŸ†• æ–°è¦IDæ¤œå‡º: ${detectedId}`;
            scanStatus.className = "bg-blue-600 text-white text-center py-3 px-4 text-sm font-bold";
            
            if (confirm(`æ–°è¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\nID: ${detectedId}`)) {
              const compressedImage = resizeAndCompressCanvas(canvas, 300, 0.5);
              
              plants.unshift({ 
                id: detectedId, 
                logs: [], 
                image: compressedImage 
              });
              save();
              
              scanStatus.textContent = "âœ… æ–°è¦ç™»éŒ²å®Œäº†ï¼";
              scanStatus.className = "bg-green-600 text-white text-center py-3 px-4 text-sm font-bold";
              
              setTimeout(() => {
                scanOverlay.classList.add('hidden');
                stopCamera();
              }, 1500);
            } else {
              scanStatus.textContent = "âŒ ç™»éŒ²ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ";
              scanStatus.className = "bg-gray-600 text-white text-center py-3 px-4 text-sm font-bold";
            }
          }
        } else {
          scanStatus.textContent = "âš ï¸ IDã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ";
          scanStatus.className = "bg-red-600 text-white text-center py-3 px-4 text-sm font-bold";
        }
      } catch (error) {
        console.error("è§£æã‚¨ãƒ©ãƒ¼:", error);
        debugInfo.textContent = "âŒ ã‚¨ãƒ©ãƒ¼:\n" + error.toString();
        scanStatus.textContent = "âŒ è§£æã«å¤±æ•—ã—ã¾ã—ãŸ";
        scanStatus.className = "bg-red-600 text-white text-center py-3 px-4 text-sm font-bold";
      }
      
      captureBtn.disabled = false;
    });

    // ========================================
    // ç”»åƒã®æ‰‹å‹•ç™»éŒ²/å¤‰æ›´
    // ========================================
    window.openImageUpload = (id) => {
      currentImageTargetId = id;
      imageFileInput.click();
    };

    imageFileInput.addEventListener('change', async (e) => {
      if (!e.target.files || !e.target.files[0] || !currentImageTargetId) return;
      
      const file = e.target.files[0];
      const plant = plants.find(p => p.id === currentImageTargetId);
      
      if (plant) {
        try {
          const compressedImage = await compressImage(file, 300, 0.5);
          plant.image = compressedImage;
          save();
        } catch (error) {
          console.error('ç”»åƒåœ§ç¸®ã‚¨ãƒ©ãƒ¼:', error);
          alert('ç”»åƒã®å‡¦ç†ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
      }
      
      e.target.value = '';
      currentImageTargetId = null;
    });

    // ========================================
    // æ¤ç‰©ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯
    // ========================================
    window.addLog = (id, type) => {
      const plant = plants.find(p => p.id === id);
      if (!plant) return;
      const today = new Date();
      const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
      const timestamp = today.getTime();
      plant.logs.unshift({ type, date: dateStr, ts: timestamp });
      if (plant.logs.length > 50) plant.logs.pop();
      save();
    };

    window.deletePlant = (id) => {
      if (!confirm(`ID: ${id} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      plants = plants.filter(p => p.id !== id);
      save();
    };

    const calculateDaysAgo = (log) => {
      if (!log) return null;
      if (log.ts) {
        const diff = Date.now() - log.ts;
        return Math.floor(diff / (1000 * 60 * 60 * 24));
      }
      try {
        const now = new Date();
        const [m, d] = log.date.split('/').map(Number);
        const logDate = new Date(now.getFullYear(), m - 1, d);
        if (logDate > now) logDate.setFullYear(now.getFullYear() - 1);
        const diff = now - logDate;
        return Math.floor(diff / (1000 * 60 * 60 * 24));
      } catch (e) {
        return null;
      }
    };

    const getDaysAgoHtml = (log) => {
      const days = calculateDaysAgo(log);
      if (days === null) return '';
      if (days === 0) return '<span class="text-teal-600 font-bold ml-1">(ä»Šæ—¥)</span>';
      return `<span class="text-gray-500 font-bold ml-1">(${days}æ—¥å‰)</span>`;
    };

    const isAlertNeeded = (plant) => {
      const lastWaterLog = plant.logs.find(l => l.type === 'æ°´');
      if (!lastWaterLog) return false;
      const days = calculateDaysAgo(lastWaterLog);
      return days !== null && days >= ALERT_DAYS;
    };

// ========================================
    // ã‚½ãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆé«˜åº¦ãªä¸¦ã³æ›¿ãˆå¯¾å¿œç‰ˆï¼‰
    // ========================================
    const sortPlants = (plantsList) => {
      const sortType = sortSelect.value;
      const sorted = [...plantsList];

      if (sortType === 'created') {
        // ãã®ã¾ã¾ï¼ˆæ–°ã—ã„é †ï¼‰
        return sorted;
      } 
      else if (sortType === 'id') {
        // IDé † (A-Z)
        return sorted.sort((a, b) => a.id.localeCompare(b.id));
      } 
      else if (sortType === 'alert') {
        // ã‚¢ãƒ©ãƒ¼ãƒˆå„ªå…ˆ
        return sorted.sort((a, b) => {
          const aDanger = isAlertNeeded(a);
          const bDanger = isAlertNeeded(b);
          // å±é™ºãªæ–¹ã‚’ä¸Šã«
          if (aDanger && !bDanger) return -1;
          if (!aDanger && bDanger) return 1;
          
          // åŒã˜ãªã‚‰æœ€çµ‚æ°´ã‚„ã‚ŠãŒå¤ã„é †
          const aLog = a.logs.find(l => l.type === 'æ°´');
          const bLog = b.logs.find(l => l.type === 'æ°´');
          const aTime = aLog ? (aLog.ts || 0) : 0;
          const bTime = bLog ? (bLog.ts || 0) : 0;
          return aTime - bTime;
        });
      }
      else if (sortType === 'dry_slow') {
        // ğŸ¢ ä¹¾ããŒé…ã„é †ï¼ˆå¹³å‡æ—¥æ•°ãŒé•·ã„é †ï¼‰
        return sorted.sort((a, b) => {
          const aAvg = calculateAverageInterval(a) || -1; // nullãªã‚‰ä¸€ç•ªä¸‹ã¸
          const bAvg = calculateAverageInterval(b) || -1;
          return bAvg - aAvg; // é™é †
        });
      }
      else if (sortType === 'dry_fast') {
        // ğŸ‡ ä¹¾ããŒé€Ÿã„é †ï¼ˆå¹³å‡æ—¥æ•°ãŒçŸ­ã„é †ï¼‰
        return sorted.sort((a, b) => {
          // null(ãƒ‡ãƒ¼ã‚¿ä¸è¶³)ã¯ä¸€ç•ªä¸‹ã«é€ã‚‹ãŸã‚ã€éå¸¸ã«å¤§ããªå€¤ã¨ã—ã¦æ‰±ã†
          const aAvg = calculateAverageInterval(a) || 9999; 
          const bAvg = calculateAverageInterval(b) || 9999;
          return aAvg - bAvg; // æ˜‡é †
        });
      }
      
      return sorted;
    };

    const filterPlants = (plantsList) => {
      if (!searchQuery) return plantsList;
      return plantsList.filter(p => p.id.toLowerCase().includes(searchQuery.toLowerCase()));
    };

    // ========================================
    // ã‚¢ã‚³ãƒ¼ãƒ‡ã‚£ã‚ªãƒ³é–‹é–‰
    // ========================================
    window.toggleAccordion = (id) => {
      const content = document.getElementById(`accordion-${id}`);
      const arrow = document.getElementById(`arrow-${id}`);
      
      content.classList.toggle('expanded');
      arrow.classList.toggle('rotated');
    };

// ========================================
    // å¹³å‡ãƒšãƒ¼ã‚¹ã®è¨ˆç®—ï¼ˆä¿®æ­£ç‰ˆï¼‰
    // æ°´ãƒ»æ¶²è‚¥ãƒ»æ´»åŠ›å‰¤ã™ã¹ã¦ã‚’å¯¾è±¡ã«é–“éš”ã‚’è¨ˆç®—
    // ========================================
    const calculateAverageInterval = (plant) => {
      // è¨ˆç®—å¯¾è±¡ã«ã™ã‚‹ãƒ­ã‚°ã®ç¨®é¡
      const targetTypes = ['æ°´', 'æ¶²è‚¥', 'æ´»åŠ›å‰¤'];
      
      // å¯¾è±¡ã®ãƒ­ã‚°ã ã‘ã‚’æŠ½å‡º
      const validLogs = plant.logs.filter(l => targetTypes.includes(l.type));
      
      if (validLogs.length < 2) return null;
      
      // æ—¥ä»˜é †ï¼ˆæ–°ã—ã„é †ï¼‰ã«ã‚½ãƒ¼ãƒˆ
      const sortedLogs = [...validLogs].sort((a, b) => b.ts - a.ts);
      
      let totalDays = 0;
      let count = 0;
      
      for (let i = 0; i < sortedLogs.length - 1; i++) {
        const days1 = calculateDaysAgo(sortedLogs[i]);
        const days2 = calculateDaysAgo(sortedLogs[i + 1]);
        
        if (days1 !== null && days2 !== null) {
          totalDays += Math.abs(days2 - days1);
          count++;
        }
      }
      
      return count > 0 ? Math.round(totalDays / count) : null;
    };


// ========================================
    // ãƒ­ã‚°è¡¨ç¤ºç”¨ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆé–¢æ•°ï¼ˆã“ã“ãŒæŠœã‘ã¦ã„ã¾ã—ãŸï¼‰
    // ========================================
    const formatLogDisplay = (log) => {
      if (!log) return '---';
      
      const date = formatDate(log.ts);
      let icon = '';
      let typeText = log.type;

      // ã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸã‚¢ã‚¤ã‚³ãƒ³ã¨ãƒ†ã‚­ã‚¹ãƒˆè¨­å®š
      switch (log.type) {
        case 'æ°´':
          icon = 'ğŸ’§';
          break;
        case 'æ¶²è‚¥':
          icon = 'ğŸ’Š';
          break;
        case 'æ´»åŠ›å‰¤':
          icon = 'âš¡';
          break;
        default:
          icon = 'ğŸ“';
      }

      return `<span class="mr-1">${date}</span><span class="text-xs bg-gray-100 px-1 py-0.5 rounded border border-gray-200">${icon}${typeText}</span>`;
    };

// ========================================
    // æç”»é–¢æ•° (Pattern 1: Dark Mode)
    // ========================================
    const render = () => {
      const filteredPlants = filterPlants(plants);
      const sortedPlants = sortPlants(filteredPlants);
      const currentSort = sortSelect.value;

      plantListEl.innerHTML = '';

      if (sortedPlants.length === 0) {
        emptyState.classList.remove('hidden');
        return;
      } else {
        emptyState.classList.add('hidden');
      }

      sortedPlants.forEach(plant => {
        const isDanger = isAlertNeeded(plant);
        
        // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç”¨ã®ã‚«ãƒ¼ãƒ‰ã‚¹ã‚¿ã‚¤ãƒ«
        const baseClass = "rounded-xl overflow-hidden relative transition-all duration-300 border shadow-lg";
        const cardClass = isDanger 
          ? `${baseClass} bg-red-900/10 border-red-500/50` 
          : `${baseClass} bg-gray-800 border-gray-700 hover:border-gray-600`;

        const sortedLogs = plant.logs ? [...plant.logs].sort((a, b) => b.ts - a.ts) : [];
        const recentLogs = sortedLogs.slice(0, 5);
        const lastLog = sortedLogs[0];
        
        // ãƒ†ã‚­ã‚¹ãƒˆè‰²èª¿æ•´
        const headerInfoHtml = lastLog 
          ? formatLogDisplay(lastLog).replace('text-gray-800', 'text-gray-200').replace('bg-gray-100', 'bg-gray-700 border-gray-600 text-gray-200')
          : '<span class="text-gray-600 text-xs">No Record</span>';
        
        const avgInterval = calculateAverageInterval(plant);
        const avgText = (avgInterval !== null) ? `<span class="text-teal-400 font-bold">${avgInterval}æ—¥</span>` : '<span class="text-gray-600">---</span>';

        // ãƒãƒƒã‚¸
        let badgeHtml = '';
        if (currentSort === 'dry_slow' && avgInterval !== null) {
          badgeHtml = `<span class="absolute top-4 right-12 bg-gray-700 text-gray-300 text-[10px] font-bold px-2 py-1 rounded border border-gray-600">AVG ${avgInterval}d</span>`;
        } else if (currentSort === 'dry_fast' && avgInterval !== null) {
          badgeHtml = `<span class="absolute top-4 right-12 bg-orange-900/50 text-orange-200 text-[10px] font-bold px-2 py-1 rounded border border-orange-700/50">AVG ${avgInterval}d</span>`;
        }

        // å±¥æ­´ãƒªã‚¹ãƒˆ (ãƒ€ãƒ¼ã‚¯ç”¨)
        let historyListHtml = '';
        if (recentLogs.length > 0) {
          historyListHtml = recentLogs.map(log => {
            let icon = 'ğŸ“'; let colorClass = 'text-gray-400 bg-gray-700 border-gray-600';
            if (log.type === 'æ°´') { icon = 'ğŸ’§'; colorClass = 'text-blue-300 bg-blue-900/30 border-blue-800/50'; }
            else if (log.type === 'æ¶²è‚¥') { icon = 'ğŸ’Š'; colorClass = 'text-green-300 bg-green-900/30 border-green-800/50'; }
            else if (log.type === 'æ´»åŠ›å‰¤') { icon = 'âš¡'; colorClass = 'text-yellow-300 bg-yellow-900/30 border-yellow-800/50'; }

            return `
              <div class="flex justify-between items-center py-2 border-b border-gray-700 last:border-0 text-sm">
                <span class="text-gray-500 font-mono text-xs">${formatDate(log.ts)}</span>
                <span class="flex-1 text-right">
                  <span class="text-xs px-2 py-1 rounded border ${colorClass}">
                    ${icon} ${log.type}
                  </span>
                </span>
              </div>
            `;
          }).join('');
        } else {
          historyListHtml = `<div class="p-3 text-center text-gray-600 text-xs italic">å±¥æ­´ãªã—</div>`;
        }

        const card = document.createElement('div');
        card.className = cardClass;
        card.dataset.plantId = plant.id;
        
        card.innerHTML = `
          ${badgeHtml}
          <div class="accordion-header p-4 flex items-center justify-between cursor-pointer hover:bg-white/5 transition" onclick="toggleAccordion('${plant.id}')">
            <div class="flex items-center gap-4">
              <div class="flex-shrink-0 text-2xl filter drop-shadow-lg">
                ${isDanger ? 'âš ï¸' : 'ğŸŒ¿'}
              </div>
              <div class="flex flex-col">
                <span class="font-bold text-gray-100 text-lg tracking-wide">${plant.id}</span>
                <div class="text-xs text-gray-500 mt-1 flex items-center">
                  <span class="mr-2">Last:</span> ${headerInfoHtml}
                </div>
              </div>
            </div>
            <div id="arrow-${plant.id}" class="arrow-icon text-gray-600 text-xl transform transition-transform duration-300">â–¼</div>
          </div>

          <div id="accordion-${plant.id}" class="accordion-content bg-gray-900/50 shadow-inner max-h-0 overflow-hidden transition-all duration-300">
            <div class="p-4 border-t border-gray-700">
              
              <div onclick="event.stopPropagation(); openImageUpload('${plant.id}')" class="w-full h-48 mb-4 cursor-pointer hover:opacity-80 transition rounded-lg overflow-hidden border border-gray-700 bg-gray-800 relative group">
                ${plant.image 
                  ? `<img src="${plant.image}" class="w-full h-full object-cover" alt="${plant.id}">`
                  : `<div class="w-full h-full flex flex-col items-center justify-center text-gray-600 text-sm">
                       <span class="text-3xl mb-2 opacity-30">ğŸ“·</span>
                       <span>No Photo</span>
                     </div>`
                }
                <div class="absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex items-center justify-center">
                  <span class="text-xs font-bold text-white border border-white/30 px-3 py-1 rounded-full backdrop-blur-sm">å¤‰æ›´</span>
                </div>
              </div>

              <div class="mb-3 px-1 flex justify-between items-end border-b border-gray-700 pb-2">
                <span class="text-xs font-bold text-gray-500 uppercase tracking-wider">History</span>
                <span class="text-xs text-gray-400">Avg Pace: ${avgText}</span>
              </div>

              <div class="bg-gray-800/50 rounded-lg px-2 py-1 mb-5">
                ${historyListHtml}
              </div>

              <div class="grid grid-cols-3 gap-3 mb-4">
                <button onclick="event.stopPropagation(); addLog('${plant.id}', 'æ¶²è‚¥')" class="bg-gray-800 hover:bg-gray-700 text-green-400 border border-green-900 font-bold py-3 text-sm rounded-lg shadow-lg active:scale-95 transition flex flex-col items-center gap-1 group">
                  <span class="group-hover:scale-110 transition">ğŸ’Š</span><span class="text-xs">æ¶²è‚¥</span>
                </button>
                <button onclick="event.stopPropagation(); addLog('${plant.id}', 'æ°´')" class="bg-teal-600 hover:bg-teal-500 text-white font-bold py-3 text-sm rounded-lg shadow-lg shadow-teal-900/50 active:scale-95 transition flex flex-col items-center gap-1 transform scale-105 border border-teal-500">
                  <span>ğŸ’§</span><span>æ°´ã‚„ã‚Š</span>
                </button>
                <button onclick="event.stopPropagation(); addLog('${plant.id}', 'æ´»åŠ›å‰¤')" class="bg-gray-800 hover:bg-gray-700 text-yellow-400 border border-yellow-900 font-bold py-3 text-sm rounded-lg shadow-lg active:scale-95 transition flex flex-col items-center gap-1 group">
                  <span class="group-hover:scale-110 transition">âš¡</span><span class="text-xs">æ´»åŠ›å‰¤</span>
                </button>
              </div>

              <div class="text-right">
                <button onclick="event.stopPropagation(); deletePlant('${plant.id}')" class="text-gray-600 hover:text-red-400 text-xs underline transition">
                  ğŸ—‘ï¸ ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤
                </button>
              </div>

            </div>
          </div>
        `;
        plantListEl.appendChild(card);
      });
    };

    // ========================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    // ========================================
    searchInput.addEventListener('input', (e) => {
      searchQuery = e.target.value;
      render();
    });

    sortSelect.addEventListener('change', () => {
      render();
    });

    // åˆæœŸæç”»
    render();
  </script>

</body>
</html>
