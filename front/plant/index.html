<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ¤ç‰©ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .guide-frame {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 80%;
      height: 200px;
      border: 3px dashed #14b8a6;
      border-radius: 12px;
      pointer-events: none;
      background: rgba(20, 184, 166, 0.1);
    }
    .guide-text {
      position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      background: #14b8a6;
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
      white-space: nowrap;
    }
    .fab {
      position: fixed;
      right: 20px;
      bottom: 80px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      z-index: 40;
    }
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: black;
      z-index: 50;
      display: flex;
      flex-direction: column;
    }
    .highlight-card {
      animation: highlight 1.5s ease-in-out;
    }
    @keyframes highlight {
      0%, 100% { background-color: white; }
      50% { background-color: #a7f3d0; }
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 pb-20">

  <!-- ========== ãƒ¡ã‚¤ãƒ³ç”»é¢ ========== -->
  <div id="mainScreen" class="max-w-md mx-auto">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <header class="bg-teal-600 text-white p-4 sticky top-0 z-30 shadow-md">
      <h1 class="text-2xl font-bold text-center">ğŸŒ¿ æ¤ç‰©ã‚µã‚¤ã‚¯ãƒ«ç®¡ç†</h1>
    </header>

    <!-- æ¤œç´¢ãƒãƒ¼ -->
    <div class="p-4 bg-white border-b">
      <input 
        type="text" 
        id="searchInput" 
        placeholder="ğŸ” IDã§æ¤œç´¢ (ä¾‹: A-01)" 
        class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:border-teal-500"
      />
    </div>

    <!-- ã‚½ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ -->
    <div class="px-4 py-2 bg-white border-b flex justify-between items-center">
      <span class="text-sm text-gray-600 font-semibold">ä¸¦ã³æ›¿ãˆ:</span>
      <select id="sortSelect" class="bg-white border border-gray-300 text-gray-700 text-sm rounded-lg p-2">
        <option value="created">â–¼ ç™»éŒ²é † (æ–°ã—ã„é †)</option>
        <option value="id">A-Z IDé †</option>
        <option value="alert">ğŸ’§ æ°´ã‚„ã‚Šå¾…ã¡é †</option>
      </select>
    </div>

    <!-- æ¤ç‰©ãƒªã‚¹ãƒˆ -->
    <div id="plantList" class="p-4 space-y-3"></div>

    <!-- ãƒªã‚¹ãƒˆãŒç©ºã®å ´åˆ -->
    <div id="emptyState" class="hidden text-center py-12 text-gray-400">
      <p class="text-lg mb-2">ğŸ“ ç™»éŒ²ã•ã‚ŒãŸæ¤ç‰©ãŒã‚ã‚Šã¾ã›ã‚“</p>
      <p class="text-sm">å³ä¸‹ã® ğŸ“· ãƒœã‚¿ãƒ³ã§æ¤ç‰©ã‚’è¿½åŠ ã§ãã¾ã™</p>
    </div>
  </div>

  <!-- ========== Floating Action Button (ã‚¹ã‚­ãƒ£ãƒ³ãƒœã‚¿ãƒ³) ========== -->
  <button id="fabBtn" class="fab bg-teal-600 hover:bg-teal-700 text-white active:scale-95 transition">
    ğŸ“·
  </button>

  <!-- ========== ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ï¼ˆã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼‰ ========== -->
  <div id="scanOverlay" class="overlay hidden">
    <!-- ã‚«ãƒ¡ãƒ©ãƒ“ãƒ¥ãƒ¼ -->
    <div class="flex-1 relative">
      <video id="video" autoplay playsinline class="w-full h-full object-cover"></video>
      <canvas id="canvas" class="hidden"></canvas>
      <div class="guide-frame">
        <div class="guide-text">ã‚¿ã‚°ã‚’ã“ã“ã«åã‚ã¦æ’®å½±</div>
      </div>
    </div>

    <!-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º -->
    <div id="scanStatus" class="bg-black/80 text-white text-center py-3 px-4 text-sm font-bold">
      ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...
    </div>

    <!-- ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ -->
    <div class="bg-black/90 p-4 flex gap-3">
      <button id="closeScanBtn" class="flex-1 bg-gray-600 hover:bg-gray-700 text-white font-bold py-4 rounded-lg text-lg">
        âœ• é–‰ã˜ã‚‹
      </button>
      <button id="captureBtn" class="flex-1 bg-teal-600 hover:bg-teal-700 text-white font-bold py-4 rounded-lg text-lg">
        ğŸ“¸ æ’®å½±
      </button>
    </div>

    <!-- ãƒ‡ãƒãƒƒã‚°æƒ…å ± -->
    <details class="bg-black/90 px-4 pb-4">
      <summary class="cursor-pointer text-xs text-gray-400">ğŸ” ãƒ‡ãƒãƒƒã‚°æƒ…å ±</summary>
      <div id="debugInfo" class="mt-2 bg-gray-800 text-gray-200 p-2 rounded text-xs whitespace-pre-wrap max-h-32 overflow-auto"></div>
    </details>
  </div>

  <script>
    // ========================================
    // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ãƒ»å®šæ•°
    // ========================================
    const STORAGE_KEY = 'plantCycleData';
    const ALERT_DAYS = 7;
    let plants = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
    let cameraStream = null;
    let searchQuery = '';

    // DOMè¦ç´ 
    const mainScreen = document.getElementById('mainScreen');
    const fabBtn = document.getElementById('fabBtn');
    const scanOverlay = document.getElementById('scanOverlay');
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const closeScanBtn = document.getElementById('closeScanBtn');
    const scanStatus = document.getElementById('scanStatus');
    const debugInfo = document.getElementById('debugInfo');
    const searchInput = document.getElementById('searchInput');
    const sortSelect = document.getElementById('sortSelect');
    const plantListEl = document.getElementById('plantList');
    const emptyState = document.getElementById('emptyState');

    // ========================================
    // ä¿å­˜ãƒ»æç”»
    // ========================================
    const save = () => {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(plants));
        render();
      } catch (e) {
        alert('ãƒ‡ãƒ¼ã‚¿å®¹é‡ãŒã„ã£ã±ã„ã§ã™ã€‚å¤ã„ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦ãã ã•ã„ã€‚');
      }
    };

    // ========================================
    // ã‚«ãƒ¡ãƒ©åˆ¶å¾¡
    // ========================================
    const startCamera = async () => {
      try {
        cameraStream = await navigator.mediaDevices.getUserMedia({ 
          video: { 
            facingMode: "environment",
            width: { ideal: 1920 },
            height: { ideal: 1080 }
          } 
        });
        video.srcObject = cameraStream;
        scanStatus.textContent = "âœ… ã‚¿ã‚°ã‚’æ’®å½±ã—ã¦ãã ã•ã„";
        scanStatus.className = "bg-green-600 text-white text-center py-3 px-4 text-sm font-bold";
      } catch (err) {
        console.error("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:", err);
        scanStatus.textContent = "âŒ ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ";
        scanStatus.className = "bg-red-600 text-white text-center py-3 px-4 text-sm font-bold";
      }
    };

    const stopCamera = () => {
      if (cameraStream) {
        cameraStream.getTracks().forEach(track => track.stop());
        cameraStream = null;
      }
    };

    // ========================================
    // ç”»åƒãƒªã‚µã‚¤ã‚ºãƒ»åœ§ç¸®
    // ========================================
    const resizeAndCompressImage = (sourceCanvas, maxWidth = 300, quality = 0.5) => {
      const tempCanvas = document.createElement('canvas');
      const ctx = tempCanvas.getContext('2d');
      
      const scale = maxWidth / sourceCanvas.width;
      const width = scale < 1 ? maxWidth : sourceCanvas.width;
      const height = scale < 1 ? sourceCanvas.height * scale : sourceCanvas.height;
      
      tempCanvas.width = width;
      tempCanvas.height = height;
      ctx.drawImage(sourceCanvas, 0, 0, width, height);
      
      return tempCanvas.toDataURL('image/jpeg', quality);
    };

    // ========================================
    // ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ã®é–‹é–‰
    // ========================================
    fabBtn.addEventListener('click', () => {
      scanOverlay.classList.remove('hidden');
      startCamera();
    });

    closeScanBtn.addEventListener('click', () => {
      scanOverlay.classList.add('hidden');
      stopCamera();
      scanStatus.textContent = "ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...";
      scanStatus.className = "bg-black/80 text-white text-center py-3 px-4 text-sm font-bold";
    });

    // ========================================
    // æ’®å½±ãƒ»AIè§£æ
    // ========================================
    captureBtn.addEventListener('click', async () => {
      const context = canvas.getContext('2d');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      context.drawImage(video, 0, 0, canvas.width, canvas.height);

      scanStatus.textContent = "â³ AIã§è§£æä¸­...";
      scanStatus.className = "bg-yellow-600 text-white text-center py-3 px-4 text-sm font-bold";
      captureBtn.disabled = true;

      try {
        const imageBase64 = canvas.toDataURL('image/jpeg', 0.95);
        debugInfo.textContent = "ğŸ“¤ ç”»åƒã‚’é€ä¿¡ä¸­...\nç”»åƒã‚µã‚¤ã‚º: " + Math.round(imageBase64.length / 1024) + " KB";
        
        const response = await fetch('/api/scan-image', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ imageBase64 })
        });

        const result = await response.json();
        debugInfo.textContent = "ğŸ“¥ Geminiã‹ã‚‰ã®è¿”ç­”:\n" + JSON.stringify(result, null, 2);
        
        if (result.id && result.id !== "NOT_FOUND") {
          const detectedId = result.id;
          const existing = plants.find(p => p.id === detectedId);

          if (existing) {
            // ãƒ‘ã‚¿ãƒ¼ãƒ³Aï¼šç™»éŒ²æ¸ˆã¿
            scanStatus.textContent = `âœ… ç™»éŒ²æ¸ˆã¿ã§ã™: ${detectedId}`;
            scanStatus.className = "bg-green-600 text-white text-center py-3 px-4 text-sm font-bold";
            
            // ã‚¹ã‚­ãƒ£ãƒ³ç”»é¢ã‚’é–‰ã˜ã‚‹
            setTimeout(() => {
              scanOverlay.classList.add('hidden');
              stopCamera();
              
              // ãƒ¡ã‚¤ãƒ³ç”»é¢ã§è©²å½“ã‚«ãƒ¼ãƒ‰ã¾ã§ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒ»ãƒã‚¤ãƒ©ã‚¤ãƒˆ
              render();
              setTimeout(() => {
                const card = document.querySelector(`[data-plant-id="${detectedId}"]`);
                if (card) {
                  card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                  card.classList.add('highlight-card');
                  setTimeout(() => card.classList.remove('highlight-card'), 1500);
                }
              }, 300);
            }, 1500);
            
          } else {
            // ãƒ‘ã‚¿ãƒ¼ãƒ³Bï¼šæ–°è¦
            scanStatus.textContent = `ğŸ†• æ–°è¦IDæ¤œå‡º: ${detectedId}`;
            scanStatus.className = "bg-blue-600 text-white text-center py-3 px-4 text-sm font-bold";
            
            if (confirm(`æ–°è¦ç™»éŒ²ã—ã¾ã™ã‹ï¼Ÿ\nID: ${detectedId}`)) {
              // ç”»åƒã‚’ãƒªã‚µã‚¤ã‚ºãƒ»åœ§ç¸®ã—ã¦ä¿å­˜
              const compressedImage = resizeAndCompressImage(canvas, 300, 0.5);
              
              plants.unshift({ 
                id: detectedId, 
                logs: [], 
                image: compressedImage 
              });
              save();
              
              scanStatus.textContent = "âœ… æ–°è¦ç™»éŒ²å®Œäº†ï¼";
              scanStatus.className = "bg-green-600 text-white text-center py-3 px-4 text-sm font-bold";
              
              setTimeout(() => {
                scanOverlay.classList.add('hidden');
                stopCamera();
              }, 1500);
            } else {
              scanStatus.textContent = "âŒ ç™»éŒ²ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ";
              scanStatus.className = "bg-gray-600 text-white text-center py-3 px-4 text-sm font-bold";
            }
          }
        } else {
          scanStatus.textContent = "âš ï¸ IDã‚’èªè­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ";
          scanStatus.className = "bg-red-600 text-white text-center py-3 px-4 text-sm font-bold";
        }
      } catch (error) {
        console.error("è§£æã‚¨ãƒ©ãƒ¼:", error);
        debugInfo.textContent = "âŒ ã‚¨ãƒ©ãƒ¼:\n" + error.toString();
        scanStatus.textContent = "âŒ è§£æã«å¤±æ•—ã—ã¾ã—ãŸ";
        scanStatus.className = "bg-red-600 text-white text-center py-3 px-4 text-sm font-bold";
      }
      
      captureBtn.disabled = false;
    });

    // ========================================
    // æ¤ç‰©ç®¡ç†ãƒ­ã‚¸ãƒƒã‚¯
    // ========================================
    window.addLog = (id, type) => {
      const plant = plants.find(p => p.id === id);
      if (!plant) return;
      const today = new Date();
      const dateStr = `${today.getMonth() + 1}/${today.getDate()}`;
      const timestamp = today.getTime();
      plant.logs.unshift({ type, date: dateStr, ts: timestamp });
      if (plant.logs.length > 50) plant.logs.pop();
      save();
    };

    window.deletePlant = (id) => {
      if (!confirm(`ID: ${id} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
      plants = plants.filter(p => p.id !== id);
      save();
    };

    const calculateDaysAgo = (log) => {
      if (!log) return null;
      if (log.ts) {
        const diff = Date.now() - log.ts;
        return Math.floor(diff / (1000 * 60 * 60 * 24));
      }
      try {
        const now = new Date();
        const [m, d] = log.date.split('/').map(Number);
        const logDate = new Date(now.getFullYear(), m - 1, d);
        if (logDate > now) logDate.setFullYear(now.getFullYear() - 1);
        const diff = now - logDate;
        return Math.floor(diff / (1000 * 60 * 60 * 24));
      } catch (e) {
        return null;
      }
    };

    const getDaysAgoHtml = (log) => {
      const days = calculateDaysAgo(log);
      if (days === null) return '';
      if (days === 0) return '<span class="text-teal-600 font-bold ml-1">(ä»Šæ—¥)</span>';
      return `<span class="text-gray-500 font-bold ml-1">(${days}æ—¥å‰)</span>`;
    };

    const isAlertNeeded = (plant) => {
      const lastWaterLog = plant.logs.find(l => l.type === 'æ°´');
      if (!lastWaterLog) return false;
      const days = calculateDaysAgo(lastWaterLog);
      return days !== null && days >= ALERT_DAYS;
    };

    const sortPlants = (plantsList) => {
      const sortType = sortSelect.value;
      const sorted = [...plantsList];

      if (sortType === 'created') {
        return sorted;
      } else if (sortType === 'id') {
        return sorted.sort((a, b) => a.id.localeCompare(b.id));
      } else if (sortType === 'alert') {
        return sorted.sort((a, b) => {
          const aDanger = isAlertNeeded(a);
          const bDanger = isAlertNeeded(b);
          if (aDanger && !bDanger) return -1;
          if (!aDanger && bDanger) return 1;
          const aLog = a.logs.find(l => l.type === 'æ°´');
          const bLog = b.logs.find(l => l.type === 'æ°´');
          const aTime = aLog ? (aLog.ts || 0) : 0;
          const bTime = bLog ? (bLog.ts || 0) : 0;
          return aTime - bTime;
        });
      }
      return sorted;
    };

    const filterPlants = (plantsList) => {
      if (!searchQuery) return plantsList;
      return plantsList.filter(p => p.id.toLowerCase().includes(searchQuery.toLowerCase()));
    };

    const render = () => {
      const filteredPlants = filterPlants(plants);
      const sortedPlants = sortPlants(filteredPlants);

      plantListEl.innerHTML = '';

      if (sortedPlants.length === 0) {
        emptyState.classList.remove('hidden');
        return;
      } else {
        emptyState.classList.add('hidden');
      }

      sortedPlants.forEach(plant => {
        const isDanger = isAlertNeeded(plant);
        const cardClass = isDanger 
          ? 'bg-red-50 rounded-xl shadow-md border-2 border-red-400 overflow-hidden'
          : 'bg-white rounded-xl shadow-md border border-gray-200 overflow-hidden';

        const alertBadge = isDanger
          ? `<div class="absolute top-0 right-0 bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-bl-lg">æ°´ã‚„ã‚Šæ³¨æ„ï¼</div>`
          : '';

        let log1Html = 'ãƒ¼';
        let log2Html = 'ãƒ¼';
        if (plant.logs[0]) log1Html = `${plant.logs[0].type} (${plant.logs[0].date}) ${getDaysAgoHtml(plant.logs[0])}`;
        if (plant.logs[1]) log2Html = `${plant.logs[1].type} (${plant.logs[1].date}) ${getDaysAgoHtml(plant.logs[1])}`;

        const card = document.createElement('div');
        card.className = cardClass;
        card.dataset.plantId = plant.id;
        
        card.innerHTML = `
          ${alertBadge}
          <div class="flex gap-3 p-3">
            ${plant.image 
              ? `<img src="${plant.image}" class="w-20 h-20 object-cover rounded-lg shadow-sm flex-shrink-0" alt="${plant.id}">`
              : `<div class="w-20 h-20 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 text-xs flex-shrink-0">ç”»åƒ<br>ãªã—</div>`
            }
            <div class="flex-1 min-w-0">
              <div class="flex justify-between items-start mb-2">
                <h2 class="text-lg font-bold text-gray-800">${plant.id}</h2>
                <button onclick="deletePlant('${plant.id}')" class="text-xs text-red-400 hover:text-red-600">å‰Šé™¤</button>
              </div>
              <div class="bg-gray-50 p-2 rounded text-xs space-y-1">
                <div class="flex justify-between">
                  <span class="font-semibold text-gray-600">å‰å›</span>
                  <span class="text-gray-700">${log1Html}</span>
                </div>
                <div class="flex justify-between">
                  <span class="font-semibold text-gray-500">å‰ã€…å›</span>
                  <span class="text-gray-500">${log2Html}</span>
                </div>
              </div>
            </div>
          </div>
          <div class="grid grid-cols-3 gap-2 p-3 pt-0">
            <button onclick="addLog('${plant.id}', 'æ¶²è‚¥')" class="bg-orange-400 hover:bg-orange-500 text-white font-bold py-2 text-sm rounded-lg active:scale-95 transition">æ¶²è‚¥</button>
            <button onclick="addLog('${plant.id}', 'æ°´')" class="bg-blue-400 hover:bg-blue-500 text-white font-bold py-2 text-sm rounded-lg active:scale-95 transition">æ°´</button>
            <button onclick="addLog('${plant.id}', 'æ´»åŠ›å‰¤')" class="bg-yellow-400 hover:bg-yellow-500 text-white font-bold py-2 text-sm rounded-lg active:scale-95 transition">æ´»åŠ›å‰¤</button>
          </div>
        `;
        plantListEl.appendChild(card);
      });
    };

    // ========================================
    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    // ========================================
    searchInput.addEventListener('input', (e) => {
      searchQuery = e.target.value;
      render();
    });

    sortSelect.addEventListener('change', () => {
      render();
    });

    // åˆæœŸæç”»
    render();
  </script>

</body>
</html>
