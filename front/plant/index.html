<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç°¡æ˜“OCRãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—</title>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body { font-family: sans-serif; padding: 20px; text-align: center; }
        video, canvas, img { max-width: 100%; border: 1px solid #ccc; margin-bottom: 10px; }
        
        /* çµæœè¡¨ç¤ºã‚¨ãƒªã‚¢ã®ãƒ‡ã‚¶ã‚¤ãƒ³ */
        .result-area {
            margin-top: 20px;
            padding: 15px;
            background: #e6f7ff;
            border-radius: 8px;
            border: 1px solid #91d5ff;
        }
        input[type="text"] {
            font-size: 20px;
            padding: 8px;
            width: 80%;
            text-align: center;
            font-weight: bold;
            border: 2px solid #ccc;
            border-radius: 4px;
        }

        #output { 
            background: #f0f0f0; 
            padding: 10px; 
            white-space: pre-wrap; 
            text-align: left; 
            min-height: 50px;
            font-size: 12px;
            border-radius: 5px;
            margin-top: 10px;
            color: #666;
        }
        button { padding: 10px 20px; font-size: 16px; cursor: pointer; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; }
        button#retry { background: #6c757d; }
        .hidden { display: none; }
    </style>
</head>
<body>

    <h2>ğŸ“· æ¤ç‰©IDã‚¹ã‚­ãƒ£ãƒŠãƒ¼</h2>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" class="hidden"></canvas>
    
    <div>
        <button id="snap">æ’®å½±ã—ã¦è§£æ</button>
        <button id="retry" class="hidden">ã‚‚ã†ä¸€åº¦</button>
    </div>

    <div class="result-area">
        <h3>èª­ã¿å–ã‚Šçµæœ (ID)</h3>
        <input type="text" id="plantIdInput" placeholder="ã“ã“ã«IDãŒå…¥ã‚Šã¾ã™">
    </div>
    <div id="status" style="margin-top:10px; font-weight:bold;">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ä¸­...</div>
    
    <details>
        <summary>è©³ç´°ãƒ­ã‚°ã‚’è¡¨ç¤º</summary>
        <div id="output"></div>
    </details>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const snapBtn = document.getElementById('snap');
        const retryBtn = document.getElementById('retry');
        const statusDiv = document.getElementById('status');
        const outputDiv = document.getElementById('output');
        const plantIdInput = document.getElementById('plantIdInput'); // ã“ã‚Œã§å–å¾—ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™

        // 1. ã‚«ãƒ¡ãƒ©ã®èµ·å‹•
        navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }) 
            .then(stream => {
                video.srcObject = stream;
                statusDiv.textContent = "æº–å‚™å®Œäº†";
            })
            .catch(err => {
                console.error("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:", err);
                statusDiv.textContent = "ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚";
            });

        // 2. æ’®å½±ã¨OCRå®Ÿè¡Œ
        snapBtn.addEventListener('click', () => {
            video.classList.add('hidden');
            canvas.classList.remove('hidden');
            snapBtn.classList.add('hidden');
            retryBtn.classList.remove('hidden');
            
            const context = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0, canvas.width, canvas.height);

            // ç”»åƒå‡¦ç†ï¼ˆç™½é»’åŒ–ï¼‰
            let imageData = context.getImageData(0, 0, canvas.width, canvas.height);
            let data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114);
                const threshold = 100; 
                const color = avg > threshold ? 255 : 0;
                data[i] = data[i + 1] = data[i + 2] = color;
            }
            context.putImageData(imageData, 0, 0);

            statusDiv.textContent = "â³ è§£æä¸­...";
            outputDiv.textContent = "";
            plantIdInput.value = ""; // å…¥åŠ›æ¬„ã‚’ã‚¯ãƒªã‚¢

            Tesseract.recognize(
                canvas, 
                'eng+jpn', 
                { logger: m => { if(m.status === 'recogn